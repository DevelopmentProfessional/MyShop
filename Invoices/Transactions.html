<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions - Shopy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e9ecef;
            min-height: 100vh;
        }
        
        .card {
            background: #343a40;
            border: 1px solid #495057;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .card-header {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            border-bottom: 1px solid #495057;
            color: #e9ecef;
        }
        
        .form-control, .form-select {
            background: #495057;
            border: 1px solid #6c757d;
            color: #e9ecef;
        }
        
        .form-control:focus, .form-select:focus {
            background: #495057;
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.25);
            color: #e9ecef;
        }
        
        .form-control::placeholder {
            color: #adb5bd;
        }
        
        .input-group-text {
            background: #495057;
            border: 1px solid #6c757d;
            color: #e9ecef;
        }
        
        .modal-content {
            background: #343a40;
            border: 1px solid #495057;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            border-bottom: 1px solid #495057;
            color: #e9ecef;
        }
        
        .modal-footer {
            border-top: 1px solid #495057;
        }
        
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        .list-group-item {
            background: #495057;
            border: 1px solid #6c757d;
            color: #e9ecef;
        }
        
        .list-group-item:hover {
            background: #5a6268;
        }
        
        .alert {
            background: #495057;
            border: 1px solid #6c757d;
            color: #e9ecef;
        }
        
        .alert-info {
            background: rgba(13, 202, 240, 0.2);
            border-color: rgba(13, 202, 240, 0.3);
            color: #0dcaf0;
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        .text-muted {
            color: #adb5bd !important;
        }
        
        .btn-outline-info {
            border-color: #0dcaf0;
            color: #0dcaf0;
        }
        
        .btn-outline-info:hover {
            background: #0dcaf0;
            border-color: #0dcaf0;
            color: #000;
        }
        
        .btn-outline-primary {
            border-color: #0d6efd;
            color: #0d6efd;
        }
        
        .btn-outline-primary:hover {
            background: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
        }
        
        .btn-outline-success {
            border-color: #198754;
            color: #198754;
        }
        
        .btn-outline-success:hover {
            background: #198754;
            border-color: #198754;
            color: #fff;
        }
        
        .btn-success {
            background: #198754;
            border-color: #198754;
        }
        
        .btn-success:hover {
            background: #157347;
            border-color: #146c43;
        }
        
        .btn-primary {
            background: #0d6efd;
            border-color: #0d6efd;
        }
        
        .btn-primary:hover {
            background: #0b5ed7;
            border-color: #0a58ca;
        }
        
        .btn-dark {
            background: #212529;
            border-color: #495057;
        }
        
        .btn-dark:hover {
            background: #343a40;
            border-color: #6c757d;
        }
        
        .navbar {
            background: #212529 !important;
            border-top: 1px solid #495057;
        }
        
        .sticky-bottom {
            z-index: 1030;
        }
        
        .shadow {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5) !important;
        }
        
        .shadow-sm {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.5) !important;
        }
        
        .z-3 {
            z-index: 1030;
        }
        
        .rounded-5 {
            border-radius: 0.5rem !important;
        }
        
        .min-vh-50 {
            min-height: 50vh;
        }
        
        .min-vh-75 {
            min-height: 75vh;
        }
        
        .min-vh-100 {
            min-height: 100vh;
        }
        
        .position-relative {
            position: relative !important;
        }
        
        .position-fixed {
            position: fixed !important;
        }
        
        .sticky-bottom {
            position: fixed !important;
            bottom: 0;
            width: 100%;
        }
        
        .w-100 {
            width: 100% !important;
        }
        
        .h-100 {
            height: 100% !important;
        }
        
        .h-auto {
            height: auto !important;
        }
        
        .d-flex {
            display: flex !important;
        }
        
        .flex-wrap {
            flex-wrap: wrap !important;
        }
        
        .align-items-center {
            align-items: center !important;
        }
        
        .justify-content-between {
            justify-content: center !important;
        }
        
        .gap-2 {
            gap: 0.5rem !important;
        }
        
        .p-0 {
            padding: 0 !important;
        }
        
        .p-2 {
            padding: 0.5rem !important;
        }
        
        .p-3 {
            padding: 1rem !important;
        }
        
        .mb-0 {
            margin-bottom: 0 !important;
        }
        
        .mb-1 {
            margin-bottom: 0.25rem !important;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem !important;
        }
        
        .mb-3 {
            margin-bottom: 1rem !important;
        }
        
        .mb-4 {
            margin-bottom: 1.5rem !important;
        }
        
        .mt-2 {
            margin-top: 0.5rem !important;
        }
        
        .ms-2 {
            margin-left: 0.5rem !important;
        }
        
        .ms-3 {
            margin-left: 1rem !important;
        }
        
        .ms-auto {
            margin-left: auto !important;
        }
        
        .me-auto {
            margin-right: auto !important;
        }
        
        .border-light {
            border-color: #f8f9fa !important;
        }
        
        .border-secondary {
            border-color: #6c757d !important;
        }
        
        .border-0 {
            border: 0 !important;
        }
        
        .border-top {
            border-top: 1px solid !important;
        }
        
        .border-bottom {
            border-bottom: 1px solid !important;
        }
        
        .rounded {
            border-radius: 0.375rem !important;
        }
        
        .rounded-circle {
            border-radius: 50% !important;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .h4 {
            font-size: 1.5rem;
        }
        
        .h6 {
            font-size: 1rem;
        }
        
        .small {
            font-size: 0.875rem;
        }
        
        .flex-grow-1 {
            flex-grow: 1 !important;
        }
        
        .flex-column {
            flex-direction: column !important;
        }
        
        .d-none {
            display: none !important;
        }
        
        .w-100 {
            width: 100% !important;
        }
        
        .text-center {
            text-align: center !important;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        .text-white {
            color: #fff !important;
        }
        
        .bg-dark {
            background-color: #212529 !important;
        }
        
        .bg-primary {
            background-color: #0d6efd !important;
        }
        
        .bg-success {
            background-color: #198754 !important;
        }
        
        .bg-warning {
            background-color: #ffc107 !important;
        }
        
        .bg-danger {
            background-color: #dc3545 !important;
        }
        
        .bg-secondary {
            background-color: #6c757d !important;
        }
        
        .bg-info {
            background-color: #0dcaf0 !important;
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <main class="container-fluid p-0 min-vh-100">
        <div class="row g-0">
            <div class="col-12">
                <!-- Header Card -->
                <div class="card shadow-sm border-0 mb-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h1 class="h4 mb-0"><i class="bi bi-arrow-repeat me-2"></i>Transactions</h1>
                    </div>
                    <div class="card-body">
                        <div id="paymentFormSection" class="mb-4 d-none"></div>
                        <div id="recentPaymentsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="sticky-bottom position-fixed bottom-0 w-100 navbar navbar-expand-lg bg-dark d-flex flex-wrap align-items-center gap-2 p-2 border-top border-secondary shadow z-3">
        <div class="container-fluid p-0 d-flex flex-wrap align-items-center gap-2">
            <a href="index.html" class="btn btn-dark border-light ms-2 rounded-5 me-auto">
                <i class="bi bi-arrow-left"></i> Back
            </a>  
            <button class="btn btn-success btn-sm rounded-5" id="addPaymentBtn">
                <i class="bi bi-plus"></i> New Transaction
            </button>
        </div>
    </nav>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Transaction</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Payment Type</label>
                        <select class="form-select" id="paymentTypeSelect">
                            <option value="one-time">One-time Payment</option>
                            <option value="recurring">Recurring Payment</option>
                        </select>
                    </div>
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="paymentAmount" placeholder="Amount" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Currency</label>
                            <select class="form-select" id="paymentCurrency">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contract</label>
                            <select class="form-select" id="paymentContract">
                                <option value="">Select contract (optional)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="paymentDescription" placeholder="Description">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="paymentStartDate" required>
                        </div>
                        <div class="mb-3 d-none" id="recurringFields">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control mb-2" id="paymentEndDate">
                            <label class="form-label">Frequency</label>
                            <select class="form-select" id="paymentFrequency">
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                                <option value="weekly">Weekly</option>
                                <option value="daily">Daily</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-2">
                            <i class="bi bi-check-circle me-2"></i>Create Payment
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    const API_URL = window.location.origin;
    let contractsList = [];

    // Modal and form elements
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    const addPaymentBtn = document.getElementById('addPaymentBtn');
    const paymentTypeSelect = document.getElementById('paymentTypeSelect');
    const recurringFields = document.getElementById('recurringFields');
    const paymentForm = document.getElementById('paymentForm');
    const paymentContract = document.getElementById('paymentContract');
    const recentPaymentsList = document.getElementById('recentPaymentsList');

    // Show modal on button click
    addPaymentBtn.addEventListener('click', () => {
        paymentForm.reset();
        paymentTypeSelect.value = 'one-time';
        recurringFields.classList.add('d-none');
        paymentModal.show();
    });

    // Toggle recurring fields
    paymentTypeSelect.addEventListener('change', () => {
        if (paymentTypeSelect.value === 'recurring') {
            recurringFields.classList.remove('d-none');
            document.getElementById('paymentEndDate').required = true;
            document.getElementById('paymentFrequency').required = true;
        } else {
            recurringFields.classList.add('d-none');
            document.getElementById('paymentEndDate').required = false;
            document.getElementById('paymentFrequency').required = false;
        }
    });

    // Load contracts for dropdown
    async function loadContracts() {
        try {
            const res = await fetch(`${API_URL}/api/contracts`);
            const contracts = await res.json();
            contractsList = contracts;
            paymentContract.innerHTML = '<option value="">Select contract (optional)</option>' +
                contracts.map(c => `<option value="${c.id}">${c.title}</option>`).join('');
        } catch (e) {
            paymentContract.innerHTML = '<option value="">Failed to load contracts</option>';
        }
    }

    // Load contracts on modal show
    addPaymentBtn.addEventListener('click', loadContracts);

    // Handle form submission
    paymentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const type = paymentTypeSelect.value;
        const amount = document.getElementById('paymentAmount').value;
        const currency = document.getElementById('paymentCurrency').value;
        const contractId = paymentContract.value;
        const description = document.getElementById('paymentDescription').value.trim();
        const startDate = document.getElementById('paymentStartDate').value;
        let endpoint = '';
        let payload = {};
        if (type === 'recurring') {
            const endDate = document.getElementById('paymentEndDate').value;
            const frequency = document.getElementById('paymentFrequency').value;
            if (!endDate || !frequency) {
                alert('End date and frequency are required for recurring payments.');
                return;
            }
            endpoint = contractId ? `/api/contracts/${contractId}/recurring-payments` : '/api/recurring-payments';
            payload = {
                amount, currency, frequency, start_date: startDate, end_date: endDate, description
            };
        } else {
            endpoint = '/api/one-time-payments';
            payload = {
                amount, currency, start_date: startDate, description, contract_id: contractId || null
            };
        }
        try {
            const res = await fetch(`${API_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Failed to create payment');
            alert('Payment created successfully!');
            paymentForm.reset();
            paymentModal.hide();
            loadRecentPayments();
        } catch (e) {
            alert('Error: ' + (e.message || 'Failed to create payment'));
        }
    });

    // Load recent payments (dummy data or fetch from backend if available)
    async function loadRecentPayments() {
        try {
            // Fetch both one-time and recurring payments
            const [oneTimeResponse, recurringResponse] = await Promise.all([
                fetch(`${API_URL}/api/one-time-payments`),
                fetch(`${API_URL}/api/recurring-payments`)
            ]);

            const oneTimePayments = await oneTimeResponse.json();
            const recurringPayments = await recurringResponse.json();

            // Combine and sort all payments by creation date
            const allPayments = [
                ...oneTimePayments.map(p => ({ ...p, type: 'one-time' })),
                ...recurringPayments.map(p => ({ ...p, type: 'recurring' }))
            ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            if (allPayments.length === 0) {
                recentPaymentsList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i> No payments found. Create your first payment using the "New Transaction" button above.
                    </div>
                `;
                return;
            }

            const paymentsHTML = allPayments.map(payment => {
                const amount = parseFloat(payment.amount).toFixed(2);
                const currency = payment.currency || 'USD';
                const status = payment.status || 'active';
                const startDate = new Date(payment.start_date).toLocaleDateString();
                const description = payment.description || 'No description';
                
                let statusBadge = '';
                switch (status.toLowerCase()) {
                    case 'active':
                        statusBadge = '<span class="badge bg-success">Active</span>';
                        break;
                    case 'completed':
                        statusBadge = '<span class="badge bg-primary">Completed</span>';
                        break;
                    case 'paused':
                        statusBadge = '<span class="badge bg-warning">Paused</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="badge bg-danger">Cancelled</span>';
                        break;
                    default:
                        statusBadge = '<span class="badge bg-secondary">' + status + '</span>';
                }

                let paymentInfo = '';
                if (payment.type === 'recurring') {
                    const frequency = payment.frequency || 'monthly';
                    paymentInfo = `Recurring - $${amount} ${currency}/${frequency}`;
                } else {
                    paymentInfo = `One-time - $${amount} ${currency}`;
                }

                let contractLink = '';
                if (payment.contract_id) {
                    contractLink = `
                        <a href="../Legal/ContractEditor.html?id=${payment.contract_id}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-file-earmark-text"></i> View Contract
                        </a>
                    `;
                }

                let detailLink = '';
                if (payment.type === 'recurring') {
                    detailLink = `
                        <a href="recurringpayment.html?id=${payment.id}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil"></i> Edit Payment
                        </a>
                    `;
                }

                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Payment #${payment.id}</h6>
                                    ${statusBadge}
                                </div>
                                <p class="mb-1 text-muted">${paymentInfo}</p>
                                <p class="mb-1 small">${description}</p>
                                <p class="mb-2 small text-muted">Start Date: ${startDate}</p>
                                ${payment.customer ? `<p class="mb-2 small text-muted">Customer: ${payment.customer}</p>` : ''}
                            </div>
                            <div class="d-flex flex-column gap-1 ms-3">
                                ${detailLink}
                                ${contractLink}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            recentPaymentsList.innerHTML = `
                <div class="list-group">
                    ${paymentsHTML}
                </div>
            `;
        } catch (error) {
            console.error('Error loading payments:', error);
            recentPaymentsList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i> Failed to load payments. Please try again.
                </div>
            `;
        }
    }

    // Initial load
    loadRecentPayments();
    </script>
</body>
</html> 