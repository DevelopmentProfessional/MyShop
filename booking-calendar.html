<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body style="overflow: hidden; height: 100vh; margin: 0; padding: 0;">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-bottom ">
        <div class="container-fluid">
             <div class="ms-auto d-flex align-items-center">
                <span class="badge bg-warning text-dark me-3" id="envBadge"></span>
                <a href="services.html" class="btn btn-outline-light me-2">
                    <i class="bi bi-list-check"></i> Manage Services
                </a>
                <a href="clients.html" class="btn btn-outline-light">
                    <i class="bi bi-people"></i> Manage Clients
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Appointments Section -->
        <div style="height: calc(50vh - 56px); position: relative; border-top: 1px solid var(--bs-border-color);">
            <div style="position: sticky; top: 0; background: var(--bs-primary); color: white; z-index: 1020; padding:2px;" 
                 class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Appointments</h4>
                <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#bookingDetailsModal">
                    <i class="bi bi-plus-circle"></i> New Appointment
                </button>
            </div>
            <div style="height: calc(50vh - 60px); overflow-y: auto;">
                <div id="appointmentsList" class="list-group"></div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div style="height: 50vh; position: relative; background: var(--bs-light);">
            <div style="position: sticky; top: 0; background: var(--bs-primary); color: white; z-index: 1020; padding:2px;" 
                 class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Calendar</h4>
                <div class="d-flex align-items-center justify-content-center">
                    <h5 id="currentMonth" class="mb-0 text-white me-2"></h5>
                    <button class="btn btn-outline-light px-2 py-1 mx-1" id="prevMonth">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-light px-2 py-1 mx-1" id="nextMonth">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div style="height: calc(50vh - 60px); overflow-y: auto;">
                <div class="table-responsive" style="overflow-y: visible;">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>Sun</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                                <th>Sat</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm">
                        <div class="mb-3">
                            <label for="serviceSelect" class="form-label">Service</label>
                            <select class="form-select" id="serviceSelect" required>
                                <option value="">Select a service</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="clientSearch" class="form-label">Client</label>
                            <select class="form-select" id="clientSearch" required>
                                <option value="">Select a client</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="dateInput" class="form-label">Date</label>
                            <input type="date" class="form-control" id="dateInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="timeSlots" class="form-label">Time</label>
                            <select class="form-select" id="timeSlots" required>
                                <option value="">Select a time</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBooking">Confirm Booking</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Client Modal -->
    <div class="modal fade" id="newClientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newClientForm">
                        <div class="mb-3">
                            <label for="newClientName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="newClientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="newClientEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="newClientPhone" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNewClient">Save Client</button>
                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed top-0 start-50 " style="z-index: 11">
        <div id="toastContainer"></div>
    </div>

    <div class="position-fixed top-50 start-50 translate-middle" id="loadingSpinner" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="modal fade" id="summaryModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Booking Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Appointment Details</h6>
                            <p><strong>Date:</strong> <span id="summaryDate"></span></p>
                            <p><strong>Time:</strong> <span id="summaryTime"></span></p>
                            <p><strong>Service:</strong> <span id="summaryService"></span></p>
                            <p><strong>Duration:</strong> <span id="summaryDuration"></span></p>
                            <p><strong>Price:</strong> <span id="summaryPrice"></span></p>
                            <p><strong>Client:</strong> <span id="summaryClient"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
                    <button type="button" class="btn btn-primary" id="finalConfirm">Confirm Booking</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const config = {
            local: 'http://localhost:3000',
            production: 'https://myshop-5hec.onrender.com'
        };
        
        // Automatically detect environment
        const isLocalhost = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1';
        const API_URL = isLocalhost ? config.local : config.production;

        // Show environment badge
        document.getElementById('envBadge').textContent = isLocalhost ? 'Development' : 'Production';

        let currentDate = new Date();
        let appointments = [];
        let services = [];
        let clients = [];

        async function loadData() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            loadingSpinner.style.display = 'block';
            
            try {
                const fetchWithTimeout = async (url, options = {}) => {
                    const timeout = 5000; // 5 seconds timeout
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeout);
                    
                    try {
                        const response = await fetch(`${API_URL}${url}`, {
                            ...options,
                            signal: controller.signal
                        });
                        clearTimeout(id);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        return response.json();
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            throw new Error(`Request to ${url} timed out`);
                        }
                        throw error;
                    }
                };

                const [appointmentsData, servicesData, clientsData] = await Promise.all([
                    fetchWithTimeout('/appointments'),
                    fetchWithTimeout('/services'),
                    fetchWithTimeout('/clients')
                ]);

                appointments = appointmentsData;
                services = servicesData;
                clients = clientsData;

                renderAppointments();
                renderCalendar();
                renderServiceOptions();
                renderClientOptions();
                
                showToast('Data loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showToast(`Failed to load data: ${error.message}`, 'danger');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function renderAppointments() {
            const appointmentsList = document.getElementById('appointmentsList');
            appointmentsList.innerHTML = appointments.map(appointment => {
                const service = services.find(s => s.id === appointment.service_id);
                const client = clients.find(c => c.id === appointment.client_id);
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${client?.name || 'Unknown Client'}</h6>
                                <small class="text-muted">${service?.name || 'Unknown Service'} - ${appointment.time}</small>
                            </div>
                            <span class="badge bg-${getStatusColor(appointment.status)}">${appointment.status}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const totalDays = lastDay.getDate();

            document.getElementById('currentMonth').textContent = 
                `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            let calendarHTML = '';
            let day = 1;
            let date = new Date(year, month, day);

            for (let i = 0; i < 6; i++) {
                calendarHTML += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < startingDay) {
                        calendarHTML += '<td></td>';
                    } else if (day > totalDays) {
                        calendarHTML += '<td></td>';
                    } else {
                        const dayAppointments = appointments.filter(a => {
                            const appointmentDate = new Date(a.date);
                            return appointmentDate.getDate() === day && 
                                   appointmentDate.getMonth() === month && 
                                   appointmentDate.getFullYear() === year;
                        });

                        calendarHTML += `
                            <td class="calendar-day ${dayAppointments.length ? 'has-appointments' : ''}" 
                                data-date="${date.toISOString().split('T')[0]}">
                                ${day}
                                ${dayAppointments.length ? 
                                    `<span class="badge bg-primary">${dayAppointments.length}</span>` : 
                                    ''}
                            </td>
                        `;
                        day++;
                        date.setDate(day);
                    }
                }
                calendarHTML += '</tr>';
            }

            document.getElementById('calendarBody').innerHTML = calendarHTML;
            addCalendarDayListeners();
        }

        function addCalendarDayListeners() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('click', () => {
                    const date = day.dataset.date;
                    document.getElementById('dateInput').value = date;
                    generateTimeSlots();
                    new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
                });
            });
        }

        function renderServiceOptions() {
            const serviceSelect = document.getElementById('serviceSelect');
            serviceSelect.innerHTML = `
                <option value="">Select a service</option>
                ${services.map(service => `
                    <option value="${service.id}" data-duration="${service.duration}">
                        ${service.name} (${service.duration} min) - $${service.price}
                    </option>
                `).join('')}
            `;
        }

        function renderClientOptions() {
            const clientSearch = document.getElementById('clientSearch');
            clientSearch.innerHTML = `
                <option value="">Select a client</option>
                ${clients.map(client => `
                    <option value="${client.id}">${client.name}</option>
                `).join('')}
            `;
        }

        function generateTimeSlots() {
            const timeSlots = document.getElementById('timeSlots');
            const serviceSelect = document.getElementById('serviceSelect');
            const selectedService = services.find(s => s.id === parseInt(serviceSelect.value));
            
            if (!selectedService) {
                timeSlots.innerHTML = '<option value="">Select a service first</option>';
                return;
            }

            const slots = [];
            const startTime = 9; // 9 AM
            const endTime = 17; // 5 PM
            const interval = 15; // 15 minutes

            for (let hour = startTime; hour < endTime; hour++) {
                for (let minute = 0; minute < 60; minute += interval) {
                    const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    slots.push(`<option value="${time}">${time}</option>`);
                }
            }

            timeSlots.innerHTML = `
                <option value="">Select a time</option>
                ${slots.join('')}
            `;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'scheduled': return 'primary';
                case 'in-progress': return 'warning';
                case 'completed': return 'success';
                case 'cancelled': return 'danger';
                case 'running-late': return 'info';
                default: return 'secondary';
            }
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex justify-content-start">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        document.getElementById('serviceSelect').addEventListener('change', generateTimeSlots);

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById('confirmBooking').addEventListener('click', async () => {
            const serviceId = document.getElementById('serviceSelect').value;
            const clientId = document.getElementById('clientSearch').value;
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeSlots').value;

            if (!serviceId || !clientId || !date || !time) {
                showToast('Please fill in all fields', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        service_id: serviceId,
                        client_id: clientId,
                        date: date,
                        time: time
                    })
                });

                if (response.ok) {
                    const newAppointment = await response.json();
                    appointments.push(newAppointment);
                    renderAppointments();
                    renderCalendar();
                    bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal')).hide();
                    document.getElementById('bookingForm').reset();
                    showToast('Appointment booked successfully', 'success');
                } else {
                    throw new Error('Failed to book appointment');
                }
            } catch (error) {
                console.error('Error booking appointment:', error);
                showToast('Failed to book appointment', 'danger');
            }
        });

        document.getElementById('saveNewClient').addEventListener('click', async () => {
            const name = document.getElementById('newClientName').value;
            const email = document.getElementById('newClientEmail').value;
            const phone = document.getElementById('newClientPhone').value;

            if (!name || !email || !phone) {
                showToast('Please fill in all fields', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/clients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, phone })
                });

                if (response.ok) {
                    const newClient = await response.json();
                    clients.push(newClient);
                    renderClientOptions();
                    bootstrap.Modal.getInstance(document.getElementById('newClientModal')).hide();
                    document.getElementById('newClientForm').reset();
                    showToast('Client added successfully', 'success');
                } else {
                    throw new Error('Failed to add client');
                }
            } catch (error) {
                console.error('Error adding client:', error);
                showToast('Failed to add client', 'danger');
            }
        });

        // Initialize
        loadData();
    </script>
</body>
</html> 