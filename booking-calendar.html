<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body class="vh-100 overflow-scroll m-0 p-0">   

    <div class="card-body p-0 sticky-top" style="overflow-y: auto;">
        <div class="table-responsive">
            <table class="table table-bordered mb-0">
                <thead>
                    <tr>
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody id="calendarBody"></tbody>
            </table>
        </div>
 
        
        <div class="card-header p-1 d-flex justify-content-between align-items-center bg-dark">
            <div class="d-flex align-items-center justify-content-end">
           
                <button class="btn btn-outline-primary px-2 py-1 mx-1" id="prevMonth">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-outline-primary px-2 py-1 mx-1" id="nextMonth">
                    <i class="bi bi-chevron-right"></i>
                </button>

    
            </div>

            <h5 id="currentMonth" class="mb-0 me-2"></h5>

             <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#bookingDetailsModal" onclick="LoadAppointmentFormData()">
                <i class="bi bi-plus-circle"></i> New Appointment
            </button>

          
        </div>

    </div>





  
<div class="card-body position-relative overflow-scroll p-0">
    <div id="appointments" class="list-group"></div>
</div> 
 
             <!-- Calendar Section -->


    
    <!-- Navigation Bar -->
    <nav class="sticky-bottom position-fixed bottom-0 w-100 navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="d-flex mx-auto">
            <a class="btn btn-warning mx-1 disabled" href="booking-calendar.html" title="Calendar"><i class="bi bi-calendar"></i></a>
            <a class="btn btn-outline-light mx-1" href="services.html" title="Services"><i class="bi bi-list-check"></i></a>
            <a class="btn btn-outline-light mx-1" href="products.html" title="Products"><i class="bi bi-box"></i></a>
            <a class="btn btn-outline-light mx-1" href="clients.html" title="Clients"><i class="bi bi-people"></i></a>
            <a class="btn btn-outline-light mx-1" href="employees.html" title="Employees"><i class="bi bi-person-badge"></i></a>
            <a class="btn btn-outline-light mx-1" href="admin.html" title="Admin"><i class="bi bi-shield-lock"></i></a>
            <a class="btn btn-outline-light mx-1" href="profile.html" title="Profile"><i class="bi bi-person"></i></a>
            <button class="btn btn-secondary me-2" onclick="loadData()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </nav>

       

 
    <!-- Booking Details Modal -->
    <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="appointmentForm">
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control" id="appointmentDate" required>
                            <label for="appointmentDate">Date</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="time" class="form-control" id="appointmentTime" required>
                            <label for="appointmentTime">Time</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="appointmentService" required>
                                <option value="">Select a service</option>
                            </select>
                            <label for="appointmentService">Service</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="appointmentClient" required>
                                <option value="">Select a client</option>
                            </select>
                            <label for="appointmentClient">Client</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="appointmentEmployee" required>
                                <option value="">Select an employee</option>
                            </select>
                            <label for="appointmentEmployee">Employee</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBooking">Confirm Booking</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Client Modal -->
    <div class="modal fade" id="newClientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newClientForm">
                        <div class="mb-3">
                            <label for="newClientName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="newClientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="newClientEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="newClientPhone" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNewClient">Save Client</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div class="modal fade" id="editAppointmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAppointmentForm">
                        <input type="hidden" id="editAppointmentId">
                        <div class="mb-3">
                            <label for="editServiceSelect" class="form-label">Service</label>
                            <select class="form-select" id="editServiceSelect" required>
                                <option value="">Select a service</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editClientSelect" class="form-label">Client</label>
                            <select class="form-select" id="editClientSelect" required>
                                <option value="">Select a client</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDateInput" class="form-label">Date</label>
                            <input type="date" class="form-control" id="editDateInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTimeSlots" class="form-label">Time</label>
                            <select class="form-select" id="editTimeSlots" required>
                                <option value="">Select a time</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStatus" required>
                                <option value="scheduled">Scheduled</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="running-late">Running Late</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAppointmentChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://myshop-5hec.onrender.com';

        // Initialize all variables with default values
        let currentDate = new Date();
        let appointments = [];
        let services = [];
        let clients = [];
        let employees = [];
        let selectedService = null;
        let selectedClient = null;
        let selectedEmployee = null;
        let selectedDate = "";
        let selectedTime = "";

        // Safe element getter with default value
        function getElement(id, defaultValue = null) {
            const element = document.getElementById(id);
            return element || defaultValue;
        }

        // Safe number conversion
        function safeNumber(value, defaultValue = 0) {
            const num = Number(value);
            return isNaN(num) ? defaultValue : num;
        }

        // Safe string conversion
        function safeString(value, defaultValue = "") {
            return String(value || defaultValue);
        }

        // Safe date conversion
        function safeDate(value, defaultValue = new Date()) {
            const date = new Date(value);
            return isNaN(date.getTime()) ? defaultValue : date;
        }

        // Safe object conversion
        function safeObject(value, defaultValue = {}) {
            return value && typeof value === 'object' ? value : defaultValue;
        }

        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                 throw error;
            }
        }
        
        async function loadData() {
            try {
                const [servicesData, clientsData, employeesData, appointmentsData] = await Promise.all([
                    fetchData(`${API_URL}/api/services`).catch(() => []),
                    fetchData(`${API_URL}/api/clients`).catch(() => []),
                    fetchData(`${API_URL}/api/employees`).catch(() => []),
                    fetchData(`${API_URL}/api/appointments`).catch(() => [])
                ]);

                services = safeObject(servicesData, []);
                clients = safeObject(clientsData, []);
                employees = safeObject(employeesData, []);
                appointments = safeObject(appointmentsData, []);

                renderCalendar();
                populateFormSelects();
            } catch (error) {
                console.error('Error loading data:', error);
             }
        }

        function populateFormSelects() {
            // Populate service select
            const serviceSelect = getElement('appointmentService');
            if (serviceSelect) {
                serviceSelect.innerHTML = '<option value="">Select a service</option>' +
                    services.map(service => 
                        `<option value="${safeNumber(service.id)}">${safeString(service.name)} - $${safeNumber(service.price).toFixed(2)} (${safeNumber(service.duration)} min)</option>`
                    ).join('');
            }

            // Populate client select
            const clientSelect = getElement('appointmentClient');
            if (clientSelect) {
                clientSelect.innerHTML = '<option value="">Select a client</option>' +
                    clients.map(client => 
                        `<option value="${safeNumber(client.id)}">${safeString(client.name)}</option>`
                    ).join('');
            }

            // Populate employee select
            const employeeSelect = getElement('appointmentEmployee');
            if (employeeSelect) {
                employeeSelect.innerHTML = '<option value="">Select an employee</option>' +
                    employees.filter(emp => emp.status === 'active').map(employee => 
                        `<option value="${safeNumber(employee.id)}">${safeString(employee.name)} (${safeString(employee.role)})</option>`
                    ).join('');
            }
        }

        function renderAppointments() {
            const appointmentsList = getElement('appointments');
            if (!appointmentsList) return;

            appointmentsList.innerHTML = appointments.map(appointment => {
                const service = services.find(s => s.id === appointment.service_id) || {};
                const client = clients.find(c => c.id === appointment.client_id) || {};
                const employee = employees.find(e => e.id === appointment.employee_id) || {};
                
                const appointmentDate = safeDate(appointment.date);
                const formattedDate = appointmentDate.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-${getStatusColor(appointment.status)} mb-1">${safeString(appointment.status)}</span> 
                                <h6 class="mb-1">${safeString(service.name, 'Unknown Service')}</h6>
                                <small class="text-muted">
                                    <div>Employee: ${safeString(employee.username, 'Unassigned')}</div>  
                                    <div>Client: ${safeString(client.name, 'Unknown Client')}</div>
                                </small>
                                <button class="btn btn-sm btn-outline-danger p-0" onclick="deleteAppointment(${safeNumber(appointment.id)})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <div class="d-flex flex-column align-items-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="sendEmail(${safeNumber(appointment.id)})">
                                    <i class="bi bi-envelope"></i> Send Email
                                </button>
                                <div>${formattedDate} at ${safeString(appointment.time)}</div> 
                                <small class="text-muted">
                                    <div>${safeNumber(appointment.duration)} min $${safeNumber(appointment.price).toFixed(2)}</div> 
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCalendar() {
          
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
 

            document.getElementById('currentMonth').textContent = 
                `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            let calendarHTML = '';
            let day = 1;

            for (let i = 0; i < 6; i++) {
                calendarHTML += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < startingDay) {
                        calendarHTML += '<td></td>';
                    } else if (day > totalDays) {
                        calendarHTML += '<td></td>';
                    } else {
                        const date = new Date(year, month, day);
                        const dayAppointments = appointments.filter(a => {
                            const appointmentDate = new Date(a.date);
                            return appointmentDate.getDate() === day-1 && 
                                   appointmentDate.getMonth() === month && 
                                   appointmentDate.getFullYear() === year;
                        });

                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const isToday = new Date().toDateString() === date.toDateString();
                        const dayClass = isToday ? 'today' : '';
                        
                        calendarHTML += `
                            <td class="calendar-day ${dayClass} ${dayAppointments.length ? 'has-appointments' : ''}" 
                                data-date="${dateString}">
                                ${day}
                                ${dayAppointments.length ? 
                                    `<span class="badge bg-primary">${dayAppointments.length}</span>` : 
                                    ''}
                            </td>
                        `;
                        day++;
                    }
                }
                calendarHTML += '</tr>';
            }

             const calendarBody = document.getElementById('calendarBody');
             
            if (calendarBody) {
                calendarBody.innerHTML = calendarHTML;
                 addCalendarDayListeners();
            } else {
                console.error("Calendar body element not found!");
            }
        }
 
        function addCalendarDayListeners() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('click', () => {
                    // Remove active class from all days
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('active'));
                    // Add active class to clicked day
                    day.classList.add('active');
                    
                    const date = day.dataset.date;
                    const [year, month, dayNum] = date.split('-').map(Number);
                    const selectedDate = new Date(year, month - 1, dayNum);
                    
                    // Update the date input in the booking form
                  //  document.getElementById('dateInput').value = String(date);



                  document.addEventListener("DOMContentLoaded", function () {
                    const dateInput = document.getElementById('dateInput');

                    if (dateInput) {
                        dateInput.value = date || "No date selected";
                    } else {
                        console.error("Error: #dateInput element not found in the DOM.");
                    }
                });
                    
                    // Filter appointments for the selected date
                    const dayAppointments = appointments.filter(a => {
                        const appointmentDate = new Date(a.date);
                        return appointmentDate.getDate() === dayNum-1 && 
                               appointmentDate.getMonth() === month - 1 && 
                               appointmentDate.getFullYear() === year;
                    });
                    
                    // Update the appointments list
                    const appointmentsList = document.getElementById('appointments');
                    appointmentsList.innerHTML = dayAppointments.map(appointment => {
                        const service = services.find(s => s.id === appointment.service_id) || {};
                        const client = clients.find(c => c.id === appointment.client_id) || {};
                        const employee = employees.find(e => e.id === appointment.employee_id) || {};
                        
                        const appointmentDate = safeDate(appointment.date);
                        const formattedDate = appointmentDate.toLocaleDateString('en-US', { 
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        
                        return `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-${getStatusColor(appointment.status)} mb-1">${safeString(appointment.status)}</span> 
                                        <h6 class="mb-1">${safeString(service.name, 'Unknown Service')}</h6>
                                        <small class="text-muted">
                                            <div>Employee: ${safeString(employee.username, 'Unassigned')}</div>  
                                            <div>Client: ${safeString(client.name, 'Unknown Client')}</div>
                                        </small>
                                        <button class="btn btn-sm btn-outline-danger p-0" onclick="deleteAppointment(${safeNumber(appointment.id)})">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    <div class="d-flex flex-column align-items-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="sendEmail(${safeNumber(appointment.id)})">
                                            <i class="bi bi-envelope"></i> Send Email
                                        </button>
                                        <div>${formattedDate} at ${safeString(appointment.time)}</div> 
                                        <small class="text-muted">
                                            <div>${safeNumber(appointment.duration)} min $${safeNumber(appointment.price).toFixed(2)}</div> 
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
 

                    // Add click listeners to appointment items
                    document.querySelectorAll('.appointment-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const appointmentId = parseInt(item.dataset.appointmentId);
                            const appointment = appointments.find(a => a.id === appointmentId);
                            if (appointment) {
                                openEditAppointmentModal(appointment);
                            }
                        });
                    });
                });
            });
        }

        function sendEmail(appointmentId) {
    // Find the appointment details
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) {
        alert("Appointment not found!");
        return;
    }

    // Prepare the email content
    const subject = `Appointment Confirmation - ${appointment.service.name}`;
    const body = `Hello ${appointment.client.name},%0D%0A%0D%0A` +
                 `Your appointment details:%0D%0A` +
                 `Service: ${appointment.service.name}%0D%0A` +
                 `Time: ${appointment.time}%0D%0A` +
                 `Duration: ${appointment.duration} min%0D%0A` +
                 `Price: $${appointment.price.toFixed(2)}%0D%0A` +
                 `Employee: ${appointment.employee.username}%0D%0A` +
                 `Status: ${appointment.status}%0D%0A%0D%0A` +
                 `Thank you for booking with us!`;

    // Open default mail client using "mailto" link
    window.location.href = `mailto:${appointment.client.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

        function openEditAppointmentModal(appointment) {
            const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
            
            // Set the appointment ID
            document.getElementById('editAppointmentId').value = appointment.id;
            
            // Populate service options
            const editServiceSelect = document.getElementById('editServiceSelect');
            editServiceSelect.innerHTML = `
                <option value="">Select a service</option>
                ${services.map(s => `
                    <option value="${s.id}" ${s.id === appointment.service_id ? 'selected' : ''}>
                        ${s.name} (${s.duration} min) - $${s.price}
                    </option>
                `).join('')}
            `;

            // Populate client options
            const editClientSelect = document.getElementById('editClientSelect');
            editClientSelect.innerHTML = `
                <option value="">Select a client</option>
                ${clients.map(c => `
                    <option value="${c.id}" ${c.id === appointment.client_id ? 'selected' : ''}>
                        ${c.name}
                    </option>
                `).join('')}
            `;

            // Set date and time
            document.getElementById('editDateInput').value = appointment.date;
            document.getElementById('editTimeSlots').value = appointment.time;
            
            // Set status
            document.getElementById('editStatus').value = appointment.status;

            // Generate time slots based on selected service
            generateEditTimeSlots();

            modal.show();
        }

        function generateEditTimeSlots() {
            const timeSlots = document.getElementById('editTimeSlots');
            const serviceSelect = document.getElementById('editServiceSelect');
            const selectedService = services.find(s => s.id === parseInt(serviceSelect.value));
            const currentTime = document.getElementById('editTimeSlots').value;
            
            if (!selectedService) {
                timeSlots.innerHTML = '<option value="">Select a service first</option>';
                return;
            }

            const slots = [];
            const startTime = 9; // 9 AM
            const endTime = 17; // 5 PM
            const interval = 15; // 15 minutes

            for (let hour = startTime; hour < endTime; hour++) {
                for (let minute = 0; minute < 60; minute += interval) {
                    const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    slots.push(`<option value="${time}" ${time === currentTime ? 'selected' : ''}>${time}</option>`);
                }
            }

            timeSlots.innerHTML = `
                <option value="">Select a time</option>
                ${slots.join('')}
            `;
        }

        function getStatusColor(status) {
            const statusMap = {
                'scheduled': 'primary',
                'in-progress': 'warning',
                'completed': 'success',
                'cancelled': 'danger',
                'running-late': 'info'
            };
            return statusMap[safeString(status)] || 'secondary';
        }
 
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        function generateTimeSlots() {
            const timeSlotsSelect = document.getElementById('timeSlots');
            const serviceSelect = document.getElementById('serviceSelect');
            const selectedService = services.find(s => s.id === parseInt(serviceSelect.value));
            
            if (!selectedService) {
                timeSlotsSelect.innerHTML = '<option value="">Select a service first</option>';
                return;
            }

            const slots = [];
            const startTime = 9; // 9 AM
            const endTime = 17; // 5 PM
            const interval = 15; // 15 minutes
            const serviceDuration = selectedService.duration || 60; // Default to 60 minutes if not specified

            // Get the selected date
            const selectedDate = document.getElementById('dateInput').value;
            if (!selectedDate) {
                timeSlotsSelect.innerHTML = '<option value="">Select a date first</option>';
                return;
            }

            // Get existing appointments for the selected date
            const existingAppointments = appointments.filter(a => a.date === selectedDate);

            for (let hour = startTime; hour < endTime; hour++) {
                for (let minute = 0; minute < 60; minute += interval) {
                    const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const slotEndTime = new Date(`2000-01-01T${time}`);
                    slotEndTime.setMinutes(slotEndTime.getMinutes() + serviceDuration);
                    
                    // Check if this time slot overlaps with any existing appointments
                    const isAvailable = !existingAppointments.some(appointment => {
                        const appointmentTime = new Date(`2000-01-01T${appointment.time}`);
                        const appointmentEndTime = new Date(appointmentTime);
                        appointmentEndTime.setMinutes(appointmentEndTime.getMinutes() + appointment.duration);
                        
                        return (time >= appointment.time && time < appointmentEndTime.toTimeString().slice(0, 5)) ||
                               (slotEndTime.toTimeString().slice(0, 5) > appointment.time && 
                                time < appointmentEndTime.toTimeString().slice(0, 5));
                    });

                    if (isAvailable) {
                        slots.push(`<option value="${time}">${time}</option>`);
                    }
                }
            }

            timeSlotsSelect.innerHTML = `
                <option value="">Select a time</option>
                ${slots.join('')}
            `;
        }

        async function handleBookingSubmit(e) {
            e.preventDefault();
            
            const serviceId = document.getElementById('serviceSelect').value;
            const clientId = document.getElementById('clientSearch').value;
            const employeeId = document.getElementById('employeeSelect').value;
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeSlots').value;
   

            try {
                const selectedService = services.find(s => s.id === parseInt(serviceId));
                const appointmentData = {
                    service_id: parseInt(serviceId),
                    client_id: parseInt(clientId),
                    employee_id: parseInt(employeeId),
                    date: date,
                    time: time,
                    duration: selectedService.duration,
                    price: selectedService.price,
                    status: 'scheduled'
                };

                const response = await fetch(`${API_URL}/api/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create appointment');
                }

                const newAppointment = await response.json();
                appointments.push(newAppointment);
                
                // Update UI
                renderCalendar();
                renderAppointments();
                generateTimeSlots();
                
                // Reset form and close modal
                document.getElementById('bookingForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal')).hide();
                
             } catch (error) {
                console.error('Error booking appointment:', error);
             }
        }

        async function deleteAppointment(id) {
            if (!confirm('Are you sure you want to delete this appointment?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/appointments/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete appointment');
                }

                // Remove appointment from local array
                appointments = appointments.filter(a => a.id !== id);
                
                // Update UI
                renderCalendar();
                renderAppointments();
                generateTimeSlots();
                
             } catch (error) {
                console.error('Error deleting appointment:', error);
             }
        }

        // Initialize event listeners safely
        document.addEventListener('DOMContentLoaded', () => {
            const serviceSelect = getElement('serviceSelect');
            if (serviceSelect) {
                serviceSelect.addEventListener('change', generateTimeSlots);
            }

            const dateInput = getElement('dateInput');
            if (dateInput) {
                dateInput.addEventListener('change', generateTimeSlots);
            }

            const bookingForm = getElement('bookingForm');
            if (bookingForm) {
                bookingForm.addEventListener('submit', handleBookingSubmit);
            }

            const prevMonth = getElement('prevMonth');
            if (prevMonth) {
                prevMonth.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
            }

            const nextMonth = getElement('nextMonth');
            if (nextMonth) {
                nextMonth.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });
            }
        });

        // Initialize
         //loadData();
 
        // Add styles for calendar days
        const style = document.createElement('style');
        style.textContent = `
            .calendar-day {
                cursor: pointer;
                padding: 10px;
                text-align: center;
                position: relative;
                border: 1px solid #dee2e6;
                min-height: 50px;
                min-width: 50px;
            }
            .calendar-day:hover {
                background-color: rgba(0, 123, 255, 0.1);
            }
            .calendar-day.active {
                background-color: rgba(0, 123, 255, 0.2);
                font-weight: bold;
            }
            .calendar-day.today {
                background-color: rgba(255, 193, 7, 0.2);
            }
            .calendar-day.has-appointments {
                font-weight: bold;
            }
            .calendar-day .badge {
                position: absolute;
                top: 2px;
                right: 2px;
            }
            .table {
                background-color: white;
            }
            .table th {
                text-align: center;
                padding: 10px;
            }
        `;
        document.head.appendChild(style);

        // Individual loading functions
        async function loadServices() {
            try {
                const response = await fetchData(`${API_URL}/api/services`);
                services = safeObject(response, []);
                const serviceSelect = getElement('appointmentService');
                if (serviceSelect) {
                    serviceSelect.innerHTML = '<option value="">Select a service</option>' +
                        services.map(service => 
                            `<option value="${safeNumber(service.id)}">${safeString(service.name)} - $${safeNumber(service.price).toFixed(2)} (${safeNumber(service.duration)} min)</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading services:', error);
             }
        }

        async function loadClients() {
            try {
                const response = await fetchData(`${API_URL}/api/clients`);
                clients = safeObject(response, []);
                const clientSelect = getElement('appointmentClient');
                if (clientSelect) {
                    clientSelect.innerHTML = '<option value="">Select a client</option>' +
                        clients.map(client => 
                            `<option value="${safeNumber(client.id)}">${safeString(client.name)}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading clients:', error);
             }
        }

        async function loadEmployees() {
            try {
                const response = await fetchData(`${API_URL}/api/employees`);
                employees = safeObject(response, []);
                const employeeSelect = getElement('appointmentEmployee');
                if (employeeSelect) {
                    employeeSelect.innerHTML = '<option value="">Select an employee</option>' +
                        employees.filter(emp => emp.status === 'active').map(employee => 
                            `<option value="${safeNumber(employee.id)}">${safeString(employee.name)} (${safeString(employee.role)})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading employees:', error);
             }
        }

        function LoadAppointmentFormData() {
            loadServices();
            loadClients();
            loadEmployees();
        }


        
        // Update the initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial data
  
            //loadAppointments();
            
            // Add event listeners
            const confirmBookingBtn = getElement('confirmBooking');
            if (confirmBookingBtn) {
                confirmBookingBtn.addEventListener('click', saveAppointment);
            }

            const prevMonth = getElement('prevMonth');
            if (prevMonth) {
                prevMonth.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
            }

            const nextMonth = getElement('nextMonth');
            if (nextMonth) {
                nextMonth.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });
            }
        });

        // Update save appointment function
        async function saveAppointment() {
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const serviceId = document.getElementById('appointmentService').value;
            const clientId = document.getElementById('appointmentClient').value;
            const employeeId = document.getElementById('appointmentEmployee').value;
            
            if (!date || !time || !serviceId || !clientId || !employeeId) {
                 return;
            }

            try {
                const service = services.find(s => s.id === parseInt(serviceId));
                if (!service) {
                    throw new Error('Selected service not found');
                }

                const response = await fetch(`${API_URL}/api/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date,
                        time,
                        service_id: parseInt(serviceId),
                        duration: service.duration,
                        price: service.price,
                        client_id: parseInt(clientId),
                        employee_id: parseInt(employeeId),
                        status: 'scheduled'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create appointment');
                }

                const appointment = await response.json();
                appointments.push(appointment);
                
                // Update UI
                renderCalendar();
                const modal = bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Reset form
                document.getElementById('appointmentForm').reset();
                
             } catch (error) {
                console.error('Error creating appointment:', error);
             }
        }

        async function loadAppointments() {
            try {
                const response = await fetchData(`${API_URL}/api/appointments`);
                appointments = safeObject(response, []);
                
                // Update the calendar and appointments list
                 renderAppointments();
                
                // If there's a selected date, update the appointments list for that date
                const selectedDate = document.querySelector('.calendar-day.active');
                if (selectedDate) {
                    const date = selectedDate.dataset.date;
                    const [year, month, day] = date.split('-').map(Number);
                    const selectedDateObj = new Date(year, month - 1, day);
                    
                    // Filter appointments for the selected date
                    const dayAppointments = appointments.filter(a => {
                        const appointmentDate = new Date(a.date);
                        return appointmentDate.getDate() === day && 
                               appointmentDate.getMonth() === month - 1 && 
                               appointmentDate.getFullYear() === year;
                    });
                    
                    // Update the appointments list
                    const appointmentsList = getElement('appointments');
                    if (appointmentsList) {
                        appointmentsList.innerHTML = dayAppointments.map(appointment => {
                            const service = services.find(s => s.id === appointment.service_id) || {};
                            const client = clients.find(c => c.id === appointment.client_id) || {};
                            const employee = employees.find(e => e.id === appointment.employee_id) || {};
                            
                            const appointmentDate = safeDate(appointment.date);
                            const formattedDate = appointmentDate.toLocaleDateString('en-US', { 
                                weekday: 'short', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                            
                            return `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-${getStatusColor(appointment.status)} mb-1">${safeString(appointment.status)}</span> 
                                            <h6 class="mb-1">${safeString(service.name, 'Unknown Service')}</h6>
                                            <small class="text-muted">
                                                <div>Employee: ${safeString(employee.username, 'Unassigned')}</div>  
                                                <div>Client: ${safeString(client.name, 'Unknown Client')}</div>
                                            </small>
                                            <button class="btn btn-sm btn-outline-danger p-0" onclick="deleteAppointment(${safeNumber(appointment.id)})">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                        <div class="d-flex flex-column align-items-end">
                                            <button class="btn btn-sm btn-outline-primary" onclick="sendEmail(${safeNumber(appointment.id)})">
                                                <i class="bi bi-envelope"></i> Send Email
                                            </button>
                                            <div>${formattedDate} at ${safeString(appointment.time)}</div> 
                                            <small class="text-muted">
                                                <div>${safeNumber(appointment.duration)} min $${safeNumber(appointment.price).toFixed(2)}</div> 
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        // Add click listeners to appointment items
                        document.querySelectorAll('.appointment-item').forEach(item => {
                            item.addEventListener('click', () => {
                                const appointmentId = parseInt(item.dataset.appointmentId);
                                const appointment = appointments.find(a => a.id === appointmentId);
                                if (appointment) {
                                    openEditAppointmentModal(appointment);
                                }
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
             }
        }
    
        renderCalendar(); 
    </script>


</body>
</html> 