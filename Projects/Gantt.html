<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Gantt Chart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.2/dist/frappe-gantt.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.2/dist/frappe-gantt.css">
</head>
<body class="bg-dark text-light">

    <nav class="sticky-bottom position-fixed bottom-0 w-100 navbar navbar-expand-lg bg-dark d-flex flex-wrap align-items-center gap-2 p-2 border-top border-secondary shadow z-3">
        <div class="container-fluid p-0 d-flex flex-wrap align-items-center gap-2">
            <a href="Projects.html" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i>Projects
            </a>
            <a href="ProjectOverview.html" class="btn btn-outline-primary" id="projectDetailsLink">
                <i class="bi bi-gear"></i> Overview
            </a>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 id="projectTitle">Project Gantt Chart</h1>
           
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Project Tasks & Timeline</h5>
            <div>
                <button class="btn btn-outline-success me-2" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                    <i class="bi bi-plus-circle"></i> Add Task
                </button>
                <button class="btn btn-outline-info" onclick="exportGantt()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>

        <!-- Task Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-dark border-secondary text-center">
                    <div class="card-body">
                        <h3 id="totalTasks">0</h3>
                        <small class="text-muted">Total Tasks</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary text-center">
                    <div class="card-body">
                        <h3 id="completedTasks">0</h3>
                        <small class="text-muted">Completed</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary text-center">
                    <div class="card-body">
                        <h3 id="inProgressTasks">0</h3>
                        <small class="text-muted">In Progress</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary text-center">
                    <div class="card-body">
                        <h3 id="pendingTasks">0</h3>
                        <small class="text-muted">Pending</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gantt Chart -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Gantt Chart</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeView('Day')">Day</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeView('Week')">Week</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeView('Month')">Month</button>
                    </div>
                </div>
                <div id="ganttChart" style="background:#222; border-radius:8px; overflow-x:auto; min-height: 400px;"></div>
            </div>
        </div>

        <!-- Task List -->
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h5 class="card-title">Task List</h5>
                <div id="taskListContent">Loading tasks...</div>
            </div>
        </div>
    </div>

    <!-- New Task Modal -->
    <div class="modal fade" id="newTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Add New Task</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newTaskForm">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control bg-dark text-light" id="taskTitle" placeholder="Task Title" required>
                            <label for="taskTitle">Task Title</label>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control bg-dark text-light" id="taskDescription" placeholder="Description" style="height: 80px"></textarea>
                            <label for="taskDescription">Description</label>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="datetime-local" class="form-control bg-dark text-light" id="taskStartTime" required>
                                    <label for="taskStartTime">Start Time</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="datetime-local" class="form-control bg-dark text-light" id="taskEndTime" required>
                                    <label for="taskEndTime">End Time</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select bg-dark text-light" id="taskStatus">
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                            <label for="taskStatus">Status</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select bg-dark text-light" id="taskAssignee">
                                <option value="">Select assignee...</option>
                            </select>
                            <label for="taskAssignee">Assignee</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select bg-dark text-light" id="taskTeam">
                                <option value="">Select team...</option>
                            </select>
                            <label for="taskTeam">Assigned Team</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="taskMilestone">
                            <label class="form-check-label" for="taskMilestone">
                                Is Milestone
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createTask()">Create Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Edit Task</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTaskForm">
                        <input type="hidden" id="editTaskId">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control bg-dark text-light" id="editTaskTitle" placeholder="Task Title" required>
                            <label for="editTaskTitle">Task Title</label>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control bg-dark text-light" id="editTaskDescription" placeholder="Description" style="height: 80px"></textarea>
                            <label for="editTaskDescription">Description</label>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="datetime-local" class="form-control bg-dark text-light" id="editTaskStartTime" required>
                                    <label for="editTaskStartTime">Start Time</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="datetime-local" class="form-control bg-dark text-light" id="editTaskEndTime" required>
                                    <label for="editTaskEndTime">End Time</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select bg-dark text-light" id="editTaskStatus">
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                            <label for="editTaskStatus">Status</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select bg-dark text-light" id="editTaskAssignee">
                                <option value="">Select assignee...</option>
                            </select>
                            <label for="editTaskAssignee">Assignee</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select bg-dark text-light" id="editTaskTeam">
                                <option value="">Select team...</option>
                            </select>
                            <label for="editTaskTeam">Assigned Team</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editTaskMilestone">
                            <label class="form-check-label" for="editTaskMilestone">
                                Is Milestone
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateTask()">Update Task</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3030';
        let projectId = new URLSearchParams(window.location.search).get('project_id');
        let ganttChart;
        let currentView = 'Week';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!projectId) {
                document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">Project ID not found. <a href="index.html">Return to projects</a></div></div>';
                return;
            }

            // Update the project details link with the correct project ID
            document.getElementById('projectDetailsLink').href = `projectOverview.html?project_id=${projectId}`;

            loadGanttData();
            setDefaultDates();
        });

        function setDefaultDates() {
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const todayStr = today.toISOString().slice(0, 16);
            const nextWeekStr = nextWeek.toISOString().slice(0, 16);
            
            document.getElementById('taskStartTime').value = todayStr;
            document.getElementById('taskEndTime').value = nextWeekStr;
        }

        async function loadGanttData() {
            try {
                const [projectRes, tasksRes, employeesRes, teamsRes] = await Promise.all([
                    fetch(`${API_URL}/api/projects/${projectId}`),
                    fetch(`${API_URL}/api/projects/${projectId}/tasks`),
                    fetch(`${API_URL}/api/employees`),
                    fetch(`${API_URL}/api/teams`)
                ]);
                
                const project = projectRes.ok ? await projectRes.json() : {};
                const tasks = tasksRes.ok ? await tasksRes.json() : [];
                const employees = employeesRes.ok ? await employeesRes.json() : [];
                const teams = teamsRes.ok ? await teamsRes.json() : [];
                
                // Update project title
                document.getElementById('projectTitle').textContent = `${project.name || 'Project'} - Gantt Chart`;
                
                // Update task summary
                updateTaskSummary(tasks);
                
                // Initialize Gantt chart
                initializeGanttChart(tasks);
                
                // Load task list
                loadTaskList(tasks, employees, teams);
                
                // Populate assignee and team dropdowns
                populateAssigneeDropdowns(employees);
                populateTeamDropdowns(teams);
                
            } catch (error) {
                console.error('Error loading Gantt data:', error);
                document.getElementById('ganttChart').innerHTML = '<div class="alert alert-danger">Failed to load Gantt data</div>';
            }
        }

        function updateTaskSummary(tasks) {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const pending = tasks.filter(t => t.status === 'pending').length;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('pendingTasks').textContent = pending;
        }

        function initializeGanttChart(tasks) {
            const ganttTasks = tasks.map(task => ({
                id: String(task.task_id),
                name: task.title,
                start: task.start_time ? task.start_time.split('T')[0] : new Date().toISOString().split('T')[0],
                end: task.end_time ? task.end_time.split('T')[0] : new Date().toISOString().split('T')[0],
                progress: task.status === 'completed' ? 100 : (task.status === 'in_progress' ? 50 : 0),
                dependencies: task.successor_task_id ? String(task.successor_task_id) : ''
            }));
            
            try {
                if (ganttChart) {
                    ganttChart.refresh(tasks);
                } else {
                    ganttChart = new Gantt("#ganttChart", ganttTasks, {
                        custom_popup_html: null,
                        view_mode: currentView,
                        bar_height: 24,
                        padding: 32,
                        header_height: 32,
                        step: 24,
                        date_format: 'YYYY-MM-DD'
                    });
                }
            } catch (error) {
                console.error('Error initializing Gantt chart:', error);
                document.getElementById('ganttChart').innerHTML = '<div class="text-muted p-3">Failed to load Gantt chart</div>';
            }
        }

        function loadTaskList(tasks, employees, teams) {
            let html = '';
            if (!tasks.length) {
                html = `<div class="text-muted text-center py-4">
                    <i class="bi bi-list-task fs-1"></i>
                    <p class="mt-2">No tasks for this project</p>
                    <p class="small">Click "Add Task" to create the first task</p>
                </div>`;
            } else {
                html = `<div class="table-responsive">
                    <table class="table table-dark table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Assignee</th>
                                <th>Team</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                tasks.forEach(task => {
                    const assignee = employees.find(e => e.id === task.assigned_to);
                    const team = teams.find(t => t.team_id === task.assigned_team_id);
                    const startTime = task.start_time ? new Date(task.start_time).toLocaleString() : '-';
                    const endTime = task.end_time ? new Date(task.end_time).toLocaleString() : '-';
                    const progress = task.status === 'completed' ? 100 : (task.status === 'in_progress' ? 50 : 0);
                    
                    html += `<tr>
                        <td>${task.title}</td>
                        <td><span class="badge bg-${getStatusColor(task.status)}">${task.status}</span></td>
                        <td>${assignee ? assignee.name : '-'}</td>
                        <td>${team ? team.name : '-'}</td>
                        <td>${startTime}</td>
                        <td>${endTime}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" style="width: ${progress}%">${progress}%</div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editTask(${task.task_id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.task_id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });
                
                html += `</tbody></table></div>`;
            }
            
            document.getElementById('taskListContent').innerHTML = html;
        }

        function populateAssigneeDropdowns(employees) {
            const assigneeSelects = ['taskAssignee', 'editTaskAssignee'];
            
            assigneeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select assignee...</option>';
                    employees.forEach(employee => {
                        select.innerHTML += `<option value="${employee.id}">${employee.name}</option>`;
                    });
                }
            });
        }

        function populateTeamDropdowns(teams) {
            const teamSelects = ['taskTeam', 'editTaskTeam'];
            
            teamSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select team...</option>';
                    teams.forEach(team => {
                        select.innerHTML += `<option value="${team.team_id}">${team.name}</option>`;
                    });
                }
            });
        }

        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'success';
                case 'in_progress': return 'primary';
                case 'pending': return 'warning';
                default: return 'secondary';
            }
        }

        function changeView(view) {
            currentView = view;
            if (ganttChart) {
                ganttChart.change_view_mode(view);
            }
        }

        async function createTask() {
            const form = document.getElementById('newTaskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                start_time: document.getElementById('taskStartTime').value,
                end_time: document.getElementById('taskEndTime').value,
                status: document.getElementById('taskStatus').value,
                assigned_to: document.getElementById('taskAssignee').value || null,
                assigned_team_id: document.getElementById('taskTeam').value || null,
                is_milestone: document.getElementById('taskMilestone').checked
            };
            
            try {
                const response = await fetch(`${API_URL}/api/projects/${projectId}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('newTaskModal')).hide();
                    form.reset();
                    setDefaultDates();
                    loadGanttData();
                } else {
                    alert('Failed to create task');
                }
            } catch (error) {
                console.error('Error creating task:', error);
                alert('Failed to create task');
            }
        }

        async function editTask(taskId) {
            try {
                const response = await fetch(`${API_URL}/api/tasks/${taskId}`);
                if (response.ok) {
                    const task = await response.json();
                    
                    document.getElementById('editTaskId').value = task.task_id;
                    document.getElementById('editTaskTitle').value = task.title;
                    document.getElementById('editTaskDescription').value = task.description || '';
                    document.getElementById('editTaskStartTime').value = task.start_time ? task.start_time.slice(0, 16) : '';
                    document.getElementById('editTaskEndTime').value = task.end_time ? task.end_time.slice(0, 16) : '';
                    document.getElementById('editTaskStatus').value = task.status;
                    document.getElementById('editTaskAssignee').value = task.assigned_to || '';
                    document.getElementById('editTaskTeam').value = task.assigned_team_id || '';
                    document.getElementById('editTaskMilestone').checked = task.is_milestone || false;
                    
                    const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                    modal.show();
                } else {
                    alert('Failed to load task details');
                }
            } catch (error) {
                console.error('Error loading task details:', error);
                alert('Failed to load task details');
            }
        }

        async function updateTask() {
            const taskId = document.getElementById('editTaskId').value;
            const taskData = {
                title: document.getElementById('editTaskTitle').value,
                description: document.getElementById('editTaskDescription').value,
                start_time: document.getElementById('editTaskStartTime').value,
                end_time: document.getElementById('editTaskEndTime').value,
                status: document.getElementById('editTaskStatus').value,
                assigned_to: document.getElementById('editTaskAssignee').value || null,
                assigned_team_id: document.getElementById('editTaskTeam').value || null,
                is_milestone: document.getElementById('editTaskMilestone').checked
            };
            
            try {
                const response = await fetch(`${API_URL}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                    loadGanttData();
                } else {
                    alert('Failed to update task');
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Failed to update task');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadGanttData();
                } else {
                    alert('Failed to delete task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task');
            }
        }

        function exportGantt() {
            // Placeholder for export functionality
            alert('Export functionality coming soon');
        }
    </script>
</body>
</html> 