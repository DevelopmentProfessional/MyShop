<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Scheduling</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-light">
  
         <div class="d-flex justify-content-between align-items-center m-2">
            <h2><i class="fas fa-calendar-week mr-3"></i>Shift Scheduling</h2>
            <div>
                <button class="btn btn-secondary" onclick="exportSchedule()">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Weekly Schedule</h5>
                        <div id="weekRange" class="mb-2 font-weight-bold"></div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm text-center align-middle" id="scheduleTable">
                                <thead class="thead-light">
                                    <tr id="scheduleTableHeader"></tr>
                                </thead>
                                <tbody>
                                    <tr id="scheduleTableRow"></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center p-3" id="loadingSpinner" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
 
    <!-- Navigation Bar -->
    <nav class="fixed-bottom w-100 navbar navbar-expand-lg bg-dark d-flex flex-wrap align-items-center gap-2 p-2 border-top border-secondary shadow z-3">
        <div class="w-100 d-flex justify-content-between align-items-center">
            <div class="d-flex">
                <a href="index.html" class="btn btn-outline-secondary m-1">
                    <i class="bi bi-arrow-left"></i>Back
                </a>
                <a href="ShiftTemplate.html" class="btn btn-outline-primary m-1">
                    <i class="bi bi-gear"></i>Shifts
                </a>
                <a href="ShiftRotationTemplate.html" class="btn btn-outline-info m-1">
                    <i class="bi bi-arrow-repeat"></i>Rotations
                </a>
            </div>
            <button class="btn btn-outline-success m-1" data-toggle="modal" data-target="#shiftAssignmentModal">
                <i class="fas fa-users"></i>Assign
            </button>
        </div>
    </nav>

    <!-- Shift Assignment Modal - Assign employees to shift templates -->
    <div class="modal fade" id="shiftAssignmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Employees to Shift</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <i class="fas fa-users mr-2"></i>
                        <strong>Shift Assignment:</strong> Select a shift template and assign multiple employees to work that shift on specific dates.
                    </div>
                    
                    <form id="shiftAssignmentForm">
                        <div class="form-group">
                            <label>Select Shift Template</label>
                            <select class="form-control" id="selectedTemplate" required>
                                <option value="">Choose a shift template</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" class="form-control" id="assignmentDate" required>
                        </div>
                        <div class="form-group">
                            <label>Select Employees</label>
                            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                <div id="employeeSelectionList">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea class="form-control" id="assignmentNotes" rows="3" placeholder="Optional notes about this assignment"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveAssignment">Assign Employees</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="../js/shift-scheduling-client.js"></script>
    
    <script>
        // Global variables
        let shiftTemplates = [];
        let employees = [];
        let activeRotations = [];
        let currentSchedule = [];

        // Load schedule data
        async function loadSchedule() {
            try {
                // Use a date range that includes the dates in your data
                // Start from a few days ago to include past assignments
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7); // Start from 7 days ago
                
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 14); // End 14 days from now
                
                const response = await shiftSchedulingAPI.getAssignments({
                    start_date: startDate.toISOString().split('T')[0],
                    end_date: endDate.toISOString().split('T')[0]
                });
                
                currentSchedule = response;
                updateScheduleDisplay();
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        // Load employees
        async function loadEmployees() {
            try {
                employees = await shiftSchedulingAPI.getEmployees();
                populateEmployeeSelection();
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Load shift templates
        async function loadShiftTemplates() {
            try {
                console.log('Debug - Loading shift templates...');
                shiftTemplates = await shiftSchedulingAPI.getActiveTemplates();
                console.log('Debug - Loaded shift templates:', shiftTemplates);
                populateTemplateSelection();
            } catch (error) {
                console.error('Error loading shift templates:', error);
            }
        }

        // Load active rotations
        async function loadActiveRotations() {
            try {
                activeRotations = await shiftSchedulingAPI.getRotations();
            } catch (error) {
                console.error('Error loading active rotations:', error);
            }
        }

        // Update schedule display
        function updateScheduleDisplay() {
            const scheduleTableHeader = $('#scheduleTableHeader');
            const scheduleTableRow = $('#scheduleTableRow');
            const weekRange = $('#weekRange');
            scheduleTableHeader.empty();
            scheduleTableRow.empty();

            // Get Monday of the current week
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - ((today.getDay() + 6) % 7));
            // Get Sunday of the current week
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Display week range
            weekRange.text(
                `${monday.toLocaleDateString()} - ${sunday.toLocaleDateString()}`
            );

            // Days of week
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            // Build header
            days.forEach(day => {
                scheduleTableHeader.append(`<th>${day}</th>`);
            });

            // Build row with each cell containing a vertical list of shift assignments
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayAssignments = currentSchedule.filter(assignment => assignment.date === dateStr);
                
                if (dayAssignments.length === 0) {
                    scheduleTableRow.append('<td><span class="text-muted small">No shifts</span></td>');
                } else {
                    const shiftList = dayAssignments.map(assignment => {
                        const timeRange = `${assignment.start_time} - ${assignment.end_time}`;
                        return `<div class="text-left mb-1">
                            <strong>${assignment.employee_name}</strong><br>
                            <small class="text-muted">${assignment.template_name}</small><br>
                            <small class="text-info">${timeRange}</small>
                        </div>`;
                    }).join('');
                    scheduleTableRow.append(`<td>${shiftList}</td>`);
                }
            }
        }

        // Populate template selection
        function populateTemplateSelection() {
            console.log('Debug - Populating template selection with:', shiftTemplates);
            const select = $('#selectedTemplate');
            select.empty().append('<option value="">Choose a shift template</option>');
            
            shiftTemplates.forEach(template => {
                console.log('Debug - Adding template option:', template);
                select.append(`<option value="${template.id}">${template.name} (${template.start_time} - ${template.end_time})</option>`);
            });
            
            console.log('Debug - Final select options:', select.find('option').map(function() { 
                return {value: this.value, text: this.text}; 
            }).get());
        }

        // Populate employee selection
        function populateEmployeeSelection() {
            const container = $('#employeeSelectionList');
            container.empty();

            employees.forEach(emp => {
                const div = $(`
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${emp.id}" id="emp_${emp.id}">
                        <label class="form-check-label" for="emp_${emp.id}">
                            ${emp.name}
                        </label>
                    </div>
                `);
                container.append(div);
            });
        }

        // Get status badge class
        function getStatusBadge(status) {
            switch(status) {
                case 'completed': return 'success';
                case 'in_progress': return 'warning';
                case 'cancelled': return 'danger';
                default: return 'secondary';
            }
        }

        // Advance rotation
        async function advanceRotation(rotationId) {
            try {
                await shiftSchedulingAPI.advanceRotation(rotationId);
                loadActiveRotations();
                loadSchedule();
            } catch (error) {
                console.error('Error advancing rotation:', error);
            }
        }

        // Save shift assignment
        $('#saveAssignment').click(async () => {
            const form = $('#shiftAssignmentForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }
            
            const selectedEmployees = [];
            $('#employeeSelectionList input:checked').each(function() {
                selectedEmployees.push($(this).val());
            });
            
            if (selectedEmployees.length === 0) {
                alert('Please select at least one employee.');
                return;
            }
            
            const templateId = parseInt($('#selectedTemplate').val());
            console.log('Debug - Template ID:', templateId);
            console.log('Debug - Template ID type:', typeof templateId);
            console.log('Debug - Selected template element:', $('#selectedTemplate')[0]);
            console.log('Debug - All template options:', $('#selectedTemplate option').map(function() { return {value: this.value, text: this.text}; }).get());
            
            if (!templateId || isNaN(templateId)) {
                alert('Please select a valid shift template.');
                return;
            }
            
            const template = shiftTemplates.find(t => t.id === templateId);
            console.log('Debug - Found template:', template);
            console.log('Debug - Available templates:', shiftTemplates);
            
            if (!template) {
                alert('Please select a valid shift template.');
                return;
            }
            
            try {
                // Create assignments for each selected employee
                for (const employeeId of selectedEmployees) {
                    const assignmentData = {
                        template_id: templateId,
                        employee_id: parseInt(employeeId),
                        date: $('#assignmentDate').val(),
                        start_time: template.start_time,
                        end_time: template.end_time,
                        notes: $('#assignmentNotes').val() || null
                    };
                    
                    console.log('Debug - Assignment data being sent:', assignmentData);
                    
                    await shiftSchedulingAPI.createAssignment(assignmentData);
                }
                
                $('#shiftAssignmentModal').modal('hide');
                form[0].reset();
                $('#employeeSelectionList input').prop('checked', false);
                loadSchedule();
            } catch (error) {
                console.error('Error saving assignment:', error);
                alert('Failed to create assignment. Please try again.');
            }
        });

        // View shift details
        function viewShift(id) {
            console.log('Viewing shift:', id);
        }

        // Export schedule
        function exportSchedule() {
            console.log('Exporting schedule');
        }

        // Initialize
        $(document).ready(() => {
            loadSchedule();
            loadEmployees();
            loadShiftTemplates();
            loadActiveRotations();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            $('#assignmentDate').val(today);
            
            // Set default times
            $('#templateStartTime').val('09:00');
            $('#templateEndTime').val('17:00');
        });
    </script>
</body>
</html> 