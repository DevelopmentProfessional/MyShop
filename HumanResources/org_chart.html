<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/orgchart@4.0.0/dist/css/orgchart.min.css">
    <style>
        body { background: #181a1b; color: #f8f9fa; }
        .orgchart { background: #181a1b !important; }
        .orgchart .node { background: #23272b; color: #f8f9fa; border: 1px solid #333; }
        .orgchart .node .title { background: #343a40; color: #fff; }
        .orgchart .node .content { color: #f8f9fa; }
        .orgchart .node .department { font-size: 0.9em; color: #bbb; }
        .orgchart .node .role { font-size: 0.9em; color: #8ecae6; }
        .orgchart .node .status { font-size: 0.8em; color: #fff; background: #198754; border-radius: 4px; padding: 2px 6px; margin-left: 6px; }
        .orgchart .node .status.inactive { background: #6c757d; }
        .orgchart .node .actions { margin-top: 6px; }
        .orgchart .node .actions button { margin-right: 4px; }
        .employee-table th, .employee-table td { vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-diagram-3 me-2"></i>Organization Chart</h2>
            <button class="btn btn-primary" id="addEmployeeBtn"><i class="bi bi-plus-circle"></i> Add Employee</button>
        </div>
        <div class="row">
            <div class="col-lg-7 mb-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary">Org Chart</div>
                    <div class="card-body p-2">
                        <div id="orgChartContainer"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 mb-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary">Employee List (No Supervisor)</div>
                    <div class="card-body p-2">
                        <table class="table table-dark table-striped table-hover employee-table mb-0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Edit</th>
                                </tr>
                            </thead>
                            <tbody id="employeeListTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Add/Edit Employee Modal -->
    <div class="modal fade" id="employeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="employeeModalTitle">Add/Edit Employee</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="employeeForm">
                        <input type="hidden" id="employeeId">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="employeeName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control bg-dark text-light border-secondary" id="employeeEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="employeePhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="employeeRole" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="employeeDepartment" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select bg-dark text-light border-secondary" id="employeeStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Supervisor</label>
                            <select class="form-select bg-dark text-light border-secondary" id="employeeSupervisor">
                                <option value="">None</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/orgchart@4.0.0/dist/js/orgchart.min.js"></script>
    <script>
const API_URL = window.location.origin;
let orgChart = null;
let employees = [];

async function fetchEmployees() {
    const res = await fetch(`${API_URL}/api/org-chart`);
    employees = await res.json();
}

function buildOrgChartData() {
    // Only include employees with a supervisor or who are supervisors
    const idMap = {};
    employees.forEach(e => { idMap[e.id] = e; });
    // Find all employees who are supervisors
    const supervisorIds = new Set(employees.filter(e => employees.some(sub => sub.supervisor_id === e.id)).map(e => e.id));
    // Only include employees who are in the tree
    const nodes = employees.filter(e => e.supervisor_id || supervisorIds.has(e.id)).map(e => ({
        id: e.id,
        name: e.name,
        title: e.role,
        department: e.department,
        email: e.email,
        phone: e.phone,
        status: e.status,
        supervisor_id: e.supervisor_id,
        children: []
    }));
    // Build tree
    const nodeMap = {};
    nodes.forEach(n => { nodeMap[n.id] = n; });
    const roots = [];
    nodes.forEach(n => {
        if (n.supervisor_id && nodeMap[n.supervisor_id]) {
            nodeMap[n.supervisor_id].children.push(n);
        } else {
            roots.push(n);
        }
    });
    return roots.length === 1 ? roots[0] : { id: 0, name: 'Company', title: '', children: roots };
}

function renderOrgChart() {
    const data = buildOrgChartData();
    if (orgChart) orgChart.destroy();
    orgChart = new OrgChart({
        'chartContainer': '#orgChartContainer',
        'data': data,
        'nodeContent': 'department',
        'pan': true,
        'zoom': true,
        'draggable': true,
        'direction': 't2b',
        'createNode': function(node, data) {
            // Add actions (edit, delete)
            const actions = document.createElement('div');
            actions.className = 'actions';
            actions.innerHTML = `
                <button class="btn btn-sm btn-outline-warning me-1" onclick="editEmployee(${data.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${data.id})"><i class="bi bi-trash"></i></button>
            `;
            node.appendChild(actions);
        }
    });
}

function renderEmployeeList() {
    const tbody = document.getElementById('employeeListTable');
    // Only employees with no supervisor
    const list = employees.filter(e => !e.supervisor_id);
    tbody.innerHTML = list.map(e => `
        <tr>
            <td>${e.name}</td>
            <td>${e.email}</td>
            <td>${e.role}</td>
            <td>${e.department}</td>
            <td><span class="badge bg-${e.status === 'active' ? 'success' : 'secondary'}">${e.status}</span></td>
            <td><button class="btn btn-sm btn-outline-warning" onclick="editEmployee(${e.id})"><i class="bi bi-pencil"></i></button></td>
        </tr>
    `).join('');
}

async function refreshChartAndList() {
    await fetchEmployees();
    renderOrgChart();
    renderEmployeeList();
}

// Add/Edit Employee Modal
const employeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));
document.getElementById('addEmployeeBtn').onclick = function() {
    showEmployeeModal();
};

function showEmployeeModal(employee = null) {
    document.getElementById('employeeModalTitle').textContent = employee ? 'Edit Employee' : 'Add Employee';
    document.getElementById('employeeId').value = employee ? employee.id : '';
    document.getElementById('employeeName').value = employee ? employee.name : '';
    document.getElementById('employeeEmail').value = employee ? employee.email : '';
    document.getElementById('employeePhone').value = employee ? employee.phone : '';
    document.getElementById('employeeRole').value = employee ? employee.role : '';
    document.getElementById('employeeDepartment').value = employee ? employee.department : '';
    document.getElementById('employeeStatus').value = employee ? employee.status : 'active';
    // Supervisor dropdown
    const supervisorSelect = document.getElementById('employeeSupervisor');
    supervisorSelect.innerHTML = '<option value="">None</option>' + employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
    supervisorSelect.value = employee && employee.supervisor_id ? employee.supervisor_id : '';
    employeeModal.show();
}

window.editEmployee = function(id) {
    const emp = employees.find(e => e.id === id);
    if (emp) showEmployeeModal(emp);
};

window.deleteEmployee = async function(id) {
    if (!confirm('Delete this employee?')) return;
    await fetch(`${API_URL}/api/employees/${id}`, { method: 'DELETE' });
    refreshChartAndList();
};

document.getElementById('employeeForm').onsubmit = async function(e) {
    e.preventDefault();
    const id = document.getElementById('employeeId').value;
    const name = document.getElementById('employeeName').value;
    const email = document.getElementById('employeeEmail').value;
    const phone = document.getElementById('employeePhone').value;
    const role = document.getElementById('employeeRole').value;
    const department = document.getElementById('employeeDepartment').value;
    const status = document.getElementById('employeeStatus').value;
    const supervisor_id = document.getElementById('employeeSupervisor').value || null;
    const payload = { name, email, phone, role, department, status, supervisor_id };
    if (id) {
        await fetch(`${API_URL}/api/employees/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    } else {
        await fetch(`${API_URL}/api/employees`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    }
    employeeModal.hide();
    refreshChartAndList();
};

// Drag-to-reparent (change supervisor)
document.addEventListener('drop', async function(e) {
    setTimeout(refreshChartAndList, 500);
});

// Initial load
refreshChartAndList();
    </script>
</body>
</html> 