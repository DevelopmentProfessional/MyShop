<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: none;
        }
        .scanner-container {
            text-align: center;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .camera-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scanner-container">
            <h2>Advanced Barcode Scanner</h2>
            
            <div class="controls">
                <select id="deviceSelect" class="form-select mb-3">
                    <option value="">Select Camera</option>
                </select>
                
                <button id="startButton" class="btn btn-primary me-2">Start Camera</button>
                <button id="stopButton" class="btn btn-danger me-2" disabled>Stop Camera</button>
            </div>
            
            <div id="status" class="alert alert-info" style="display: none;"></div>
            <div id="cameraInfo" class="camera-info" style="display: none;"></div>
            
            <video id="video" autoplay playsinline></video>
            
            <div class="mt-3">
                <input type="text" id="barcodeInput" class="form-control mb-2" placeholder="Enter barcode manually">
                <button id="manualUpdateBtn" class="btn btn-warning" >Update Barcode</button>
            </div>
            
            <div id="result" class="result"></div>

            <div class="mb-3">
                <label for="cameraSelect" class="form-label">Select Camera:</label>
                <select class="form-select" id="cameraSelect">
                    <option value="">Loading cameras...</option>
                </select>
            </div>
            
         
            
        
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <script>
        const API_URL = window.location.origin;
        let productId = null;
        let isRunning = false;
        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let codeReader = null;
        let videoStream = null;
        let currentDetectionMethod = '';

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        productId = urlParams.get('id');

        if (!productId) {
            showStatus('No product ID provided', 'danger');
        }

        // Clear camera cache and reset permissions
        async function clearCameraCache() {
            showStatus('Clearing camera cache and resetting permissions...', 'info');
            
            try {
                // Stop any existing streams
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                
                if (codeReader) {
                    codeReader.reset();
                    codeReader = null;
                }
                
                // Reset video element
                const video = document.getElementById('video');
                video.style.display = 'none';
                video.srcObject = null;
                
                // Try to reset permissions by requesting access
                try {
                    const testStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    testStream.getTracks().forEach(track => track.stop());
                    console.log('Camera permissions reset successfully');
                } catch (err) {
                    console.log('Permission reset attempt:', err.message);
                }
                
                // Clear device list and reinitialize
                document.getElementById('deviceSelect').innerHTML = '<option value="">Select Camera</option>';
                
                showStatus('Camera cache cleared. Reinitializing detection...', 'success');
                
                // Wait a moment then reinitialize
                setTimeout(() => {
                    initializeCameraDevices();
                }, 1000);
                
            } catch (err) {
                console.error('Error clearing camera cache:', err);
                showStatus('Error clearing cache: ' + err.message, 'danger');
            }
        }

        // Ultra-aggressive camera detection with comprehensive fallbacks
        async function detectCamerasUltraAggressive() {
            console.log('Starting ULTRA-AGGRESSIVE camera detection...');
            
            const results = {
                devices: [],
                methods: [],
                errors: []
            };
            
            // Method 1: Standard enumerateDevices with permission request
            try {
                console.log('Method 1: Standard enumerateDevices with permission request');
                
                // First request permission to get device labels
                await navigator.mediaDevices.getUserMedia({ video: true });
                const allDevices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = allDevices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length > 0) {
                    results.devices = videoDevices;
                    results.methods.push('standardEnumerate');
                    console.log('Method 1 SUCCESS: Found', videoDevices.length, 'specific cameras');
                    console.log('Camera details:', videoDevices.map(d => ({
                        deviceId: d.deviceId,
                        label: d.label,
                        groupId: d.groupId
                    })));
                }
            } catch (err) {
                console.error('Method 1 failed:', err);
                results.errors.push({ method: 'standardEnumerate', error: err });
            }
            
            // Method 2: Try with different facing modes to get specific cameras
            if (results.devices.length === 0) {
                const facingModes = ['environment', 'user', 'left', 'right'];
                for (const facingMode of facingModes) {
                    try {
                        console.log(`Method 2: Trying facingMode: ${facingMode}`);
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: facingMode } 
                        });
                        
                        // Get specific device info from the stream
                        const tracks = stream.getTracks();
                        const devices = tracks.map(track => {
                            const settings = track.getSettings();
                            const capabilities = track.getCapabilities();
                            return {
                                deviceId: settings.deviceId || `facing_${facingMode}_${Date.now()}`,
                                kind: 'videoinput',
                                label: `${facingMode.charAt(0).toUpperCase() + facingMode.slice(1)} Camera (${settings.width}x${settings.height})`,
                                groupId: settings.groupId || `facing_${facingMode}_group`,
                                settings: settings,
                                capabilities: capabilities
                            };
                        });
                        
                        if (devices.length > 0) {
                            results.devices = devices;
                            results.methods.push(`facingMode_${facingMode}`);
                            console.log(`Method 2 SUCCESS: Got specific camera with facingMode ${facingMode}`);
                            console.log('Camera details:', devices);
                            stream.getTracks().forEach(track => track.stop());
                            break;
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    } catch (err) {
                        console.error(`Method 2 failed for ${facingMode}:`, err);
                    }
                }
            }
            
            // Method 3: Try with different resolutions to get specific camera capabilities
            if (results.devices.length === 0) {
                const resolutions = [
                    { width: 320, height: 240 },
                    { width: 640, height: 480 },
                    { width: 1280, height: 720 },
                    { width: 1920, height: 1080 }
                ];
                for (const res of resolutions) {
                    try {
                        console.log(`Method 3: Trying resolution ${res.width}x${res.height}`);
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                width: { exact: res.width },
                                height: { exact: res.height }
                            } 
                        });
                        
                        const tracks = stream.getTracks();
                        const devices = tracks.map(track => {
                            const settings = track.getSettings();
                            const capabilities = track.getCapabilities();
                            return {
                                deviceId: settings.deviceId || `res_${res.width}x${res.height}_${Date.now()}`,
                                kind: 'videoinput',
                                label: `Camera (${res.width}x${res.height} - ${settings.frameRate || 'unknown'}fps)`,
                                groupId: settings.groupId || `res_${res.width}x${res.height}_group`,
                                settings: settings,
                                capabilities: capabilities
                            };
                        });
                        
                        if (devices.length > 0) {
                            results.devices = devices;
                            results.methods.push(`resolution_${res.width}x${res.height}`);
                            console.log(`Method 3 SUCCESS: Got specific camera with resolution ${res.width}x${res.height}`);
                            console.log('Camera details:', devices);
                            stream.getTracks().forEach(track => track.stop());
                            break;
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    } catch (err) {
                        console.error(`Method 3 failed for ${res.width}x${res.height}:`, err);
                    }
                }
            }
            
            // Method 4: Try with different frame rates to get specific camera info
            if (results.devices.length === 0) {
                const frameRates = [15, 24, 30, 60];
                for (const fps of frameRates) {
                    try {
                        console.log(`Method 4: Trying frameRate: ${fps}`);
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { frameRate: { exact: fps } } 
                        });
                        
                        const tracks = stream.getTracks();
                        const devices = tracks.map(track => {
                            const settings = track.getSettings();
                            const capabilities = track.getCapabilities();
                            return {
                                deviceId: settings.deviceId || `fps_${fps}_${Date.now()}`,
                                kind: 'videoinput',
                                label: `Camera (${settings.width || 'unknown'}x${settings.height || 'unknown'} - ${fps}fps)`,
                                groupId: settings.groupId || `fps_${fps}_group`,
                                settings: settings,
                                capabilities: capabilities
                            };
                        });
                        
                        if (devices.length > 0) {
                            results.devices = devices;
                            results.methods.push(`frameRate_${fps}`);
                            console.log(`Method 4 SUCCESS: Got specific camera with frameRate ${fps}`);
                            console.log('Camera details:', devices);
                            stream.getTracks().forEach(track => track.stop());
                            break;
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    } catch (err) {
                        console.error(`Method 4 failed for ${fps}fps:`, err);
                    }
                }
            }
            
            // Method 5: Try with different aspect ratios to get specific camera info
            if (results.devices.length === 0) {
                const aspectRatios = [1.33, 1.77, 2.39];
                for (const ratio of aspectRatios) {
                    try {
                        console.log(`Method 5: Trying aspectRatio: ${ratio}`);
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { aspectRatio: { exact: ratio } } 
                        });
                        
                        const tracks = stream.getTracks();
                        const devices = tracks.map(track => {
                            const settings = track.getSettings();
                            const capabilities = track.getCapabilities();
                            return {
                                deviceId: settings.deviceId || `aspect_${ratio}_${Date.now()}`,
                                kind: 'videoinput',
                                label: `Camera (${ratio}:1 ratio - ${settings.width || 'unknown'}x${settings.height || 'unknown'})`,
                                groupId: settings.groupId || `aspect_${ratio}_group`,
                                settings: settings,
                                capabilities: capabilities
                            };
                        });
                        
                        if (devices.length > 0) {
                            results.devices = devices;
                            results.methods.push(`aspectRatio_${ratio}`);
                            console.log(`Method 5 SUCCESS: Got specific camera with aspectRatio ${ratio}`);
                            console.log('Camera details:', devices);
                            stream.getTracks().forEach(track => track.stop());
                            break;
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    } catch (err) {
                        console.error(`Method 5 failed for aspectRatio ${ratio}:`, err);
                    }
                }
            }
            
            // Method 6: Try with different video codecs to get specific camera info
            if (results.devices.length === 0) {
                const codecs = ['h264', 'vp8', 'vp9', 'h265'];
                for (const codec of codecs) {
                    try {
                        console.log(`Method 6: Trying codec: ${codec}`);
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            },
                            audio: false
                        });
                        
                        const tracks = stream.getTracks();
                        const devices = tracks.map(track => {
                            const settings = track.getSettings();
                            const capabilities = track.getCapabilities();
                            return {
                                deviceId: settings.deviceId || `codec_${codec}_${Date.now()}`,
                                kind: 'videoinput',
                                label: `Camera (${codec} - ${settings.width || 'unknown'}x${settings.height || 'unknown'})`,
                                groupId: settings.groupId || `codec_${codec}_group`,
                                settings: settings,
                                capabilities: capabilities
                            };
                        });
                        
                        if (devices.length > 0) {
                            results.devices = devices;
                            results.methods.push(`codec_${codec}`);
                            console.log(`Method 6 SUCCESS: Got specific camera with codec ${codec}`);
                            console.log('Camera details:', devices);
                            stream.getTracks().forEach(track => track.stop());
                            break;
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    } catch (err) {
                        console.error(`Method 6 failed for codec ${codec}:`, err);
                    }
                }
            }
            
            // Method 7: Try with different browser prefixes to get specific camera info
            if (results.devices.length === 0) {
                const getUserMediaVariants = [
                    navigator.getUserMedia,
                    navigator.webkitGetUserMedia,
                    navigator.mozGetUserMedia,
                    navigator.msGetUserMedia,
                    navigator.oGetUserMedia
                ];
                
                for (let i = 0; i < getUserMediaVariants.length; i++) {
                    const getUserMedia = getUserMediaVariants[i];
                    if (getUserMedia) {
                        try {
                            console.log(`Method 7: Trying getUserMedia variant ${i}`);
                            const stream = await new Promise((resolve, reject) => {
                                getUserMedia.call(navigator, { video: true }, resolve, reject);
                            });
                            
                            const tracks = stream.getTracks();
                            const devices = tracks.map(track => {
                                const settings = track.getSettings ? track.getSettings() : {};
                                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                                return {
                                    deviceId: settings.deviceId || `legacy_variant_${i}_${Date.now()}`,
                                    kind: 'videoinput',
                                    label: `Legacy Camera (variant ${i} - ${settings.width || 'unknown'}x${settings.height || 'unknown'})`,
                                    groupId: settings.groupId || `legacy_variant_${i}_group`,
                                    settings: settings,
                                    capabilities: capabilities
                                };
                            });
                            
                            if (devices.length > 0) {
                                results.devices = devices;
                                results.methods.push(`legacyVariant_${i}`);
                                console.log(`Method 7 SUCCESS: Got specific camera with legacy variant ${i}`);
                                console.log('Camera details:', devices);
                                stream.getTracks().forEach(track => track.stop());
                                break;
                            }
                            
                            stream.getTracks().forEach(track => track.stop());
                        } catch (err) {
                            console.error(`Method 7 failed for variant ${i}:`, err);
                        }
                    }
                }
            }
            
            // Method 8: Try with different constraint combinations to get specific camera info
            if (results.devices.length === 0) {
                const constraintCombinations = [
                    { video: { width: { min: 1 }, height: { min: 1 } } },
                    { video: { width: { max: 9999 }, height: { max: 9999 } } },
                    { video: { width: { ideal: 1 }, height: { ideal: 1 } } },
                    { video: { frameRate: { min: 1 } } },
                    { video: { frameRate: { max: 999 } } },
                    { video: { aspectRatio: { min: 0.1 } } },
                    { video: { aspectRatio: { max: 10 } } }
                ];
                
                for (let i = 0; i < constraintCombinations.length; i++) {
                    try {
                        console.log(`Method 8: Trying constraint combination ${i}`);
                        const stream = await navigator.mediaDevices.getUserMedia(constraintCombinations[i]);
                        
                        const tracks = stream.getTracks();
                        const devices = tracks.map(track => {
                            const settings = track.getSettings();
                            const capabilities = track.getCapabilities();
                            return {
                                deviceId: settings.deviceId || `combo_${i}_${Date.now()}`,
                                kind: 'videoinput',
                                label: `Camera (combo ${i} - ${settings.width || 'unknown'}x${settings.height || 'unknown'})`,
                                groupId: settings.groupId || `combo_${i}_group`,
                                settings: settings,
                                capabilities: capabilities
                            };
                        });
                        
                        if (devices.length > 0) {
                            results.devices = devices;
                            results.methods.push(`constraintCombo_${i}`);
                            console.log(`Method 8 SUCCESS: Got specific camera with constraint combo ${i}`);
                            console.log('Camera details:', devices);
                            stream.getTracks().forEach(track => track.stop());
                            break;
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    } catch (err) {
                        console.error(`Method 8 failed for combo ${i}:`, err);
                    }
                }
            }
            
            console.log('ULTRA-AGGRESSIVE detection results:', results);
            return results;
        }

        // Initialize camera devices with ultra-aggressive detection
        async function initializeCameraDevices() {
            showStatus('Starting ULTRA-AGGRESSIVE camera detection...', 'info');
            
            try {
                console.log('Starting ULTRA-AGGRESSIVE camera initialization...');
                console.log('Is mobile:', isMobile);
                console.log('User agent:', navigator.userAgent);
                console.log('Browser info:', {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    vendor: navigator.vendor,
                    mediaDevices: !!navigator.mediaDevices,
                    getUserMedia: !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia)
                });
                
                // Use ultra-aggressive detection
                const detectionResults = await detectCamerasUltraAggressive();
                console.log('Ultra-aggressive detection results:', detectionResults);
                
                if (detectionResults.devices.length === 0) {
                    showStatus('ALL camera detection methods failed. This device may not support camera access.', 'danger');
                    document.getElementById('startButton').disabled = true;
                    
                    // Show detailed error information
                    if (detectionResults.errors.length > 0) {
                        console.error('All ultra-aggressive detection methods failed:');
                        detectionResults.errors.forEach((error, index) => {
                            console.error(`Method ${index + 1} (${error.method}):`, error.error);
                        });
                    }
                    
                    // Add a manual entry option
                    const deviceSelect = document.getElementById('deviceSelect');
                    deviceSelect.innerHTML = '';
                    deviceSelect.style.display = 'block';
                    
                    const manualOption = document.createElement('option');
                    manualOption.value = 'manual_camera';
                    manualOption.text = '📝 Manual Camera Entry (No Detection)';
                    deviceSelect.appendChild(manualOption);
                    
                    showStatus('Camera detection failed. You can still manually enter barcodes.', 'warning');
                    document.getElementById('startButton').disabled = false;
                    return;
                }
                
                // Always show device select
                const deviceSelect = document.getElementById('deviceSelect');
                deviceSelect.innerHTML = '';
                deviceSelect.style.display = 'block';
                
                detectionResults.devices.forEach((device, idx) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    // Better device labeling with detection method info
                    let deviceName = device.label || `Camera ${idx + 1}`;
                    
                    // Add detection method info
                    if (detectionResults.methods.length > 0) {
                        deviceName += ` [${detectionResults.methods[0]}]`;
                    }
                    
                    option.text = deviceName;
                    deviceSelect.appendChild(option);
                });
                
                currentDetectionMethod = detectionResults.methods.join(', ');
                showStatus(`Found ${detectionResults.devices.length} camera(s) using ULTRA-AGGRESSIVE method: ${currentDetectionMethod}. Select camera and click Start Camera.`, 'success');
                document.getElementById('startButton').disabled = false;
                
                // Show camera info
                showCameraInfo(detectionResults);
                
            } catch (err) {
                console.error('ULTRA-AGGRESSIVE camera detection failed:', err);
                console.error('Error details:', {
                    name: err.name,
                    message: err.message,
                    stack: err.stack
                });
                
                let errorMessage = 'Camera detection failed.';
                if (err.name === 'NotAllowedError') {
                    errorMessage = 'Camera access denied. Please allow camera permissions in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage = 'No camera found. Please check your device.';
                } else if (err.name === 'NotReadableError') {
                    errorMessage = 'Camera is in use by another application. Please close other apps using the camera.';
                } else if (err.name === 'NotSupportedError') {
                    errorMessage = 'Camera not supported by this browser. Please try a different browser.';
                }
                
                showStatus(errorMessage, 'danger');
                document.getElementById('startButton').disabled = true;
            }
        }

        // Show camera information
        function showCameraInfo(detectionResults) {
            const cameraInfo = document.getElementById('cameraInfo');
            cameraInfo.style.display = 'block';
            cameraInfo.innerHTML = `
                <strong>Detection Method:</strong> ${currentDetectionMethod}<br>
                <strong>Devices Found:</strong> ${detectionResults.devices.length}<br>
                <strong>Mobile Device:</strong> ${isMobile ? 'Yes' : 'No'}<br>
                <strong>Browser:</strong> ${navigator.userAgent.split(' ').pop()}<br>
                <strong>Platform:</strong> ${navigator.platform}
            `;
        }

        // Check if camera is in use
        async function checkCameraInUse(deviceId) {
            try {
                console.log('Checking if camera is in use:', deviceId);
                
                // Try to get a test stream with the device
                const testStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 1 },
                        height: { ideal: 1 }
                    }
                });
                
                // If we get here, camera is available
                testStream.getTracks().forEach(track => track.stop());
                console.log('Camera is available');
                return { inUse: false, error: null };
                
            } catch (err) {
                console.log('Camera check error:', err.name, err.message);
                
                if (err.name === 'NotReadableError' || err.name === 'AbortError') {
                    return { inUse: true, error: 'Camera is currently in use by another application' };
                } else if (err.name === 'NotAllowedError') {
                    return { inUse: false, error: 'Camera access denied. Please allow camera permissions.' };
                } else if (err.name === 'NotFoundError') {
                    return { inUse: false, error: 'Camera not found. It may have been disconnected.' };
                } else if (err.name === 'OverconstrainedError') {
                    return { inUse: false, error: 'Camera does not support the required settings.' };
                } else {
                    return { inUse: false, error: `Camera error: ${err.message}` };
                }
            }
        }

        // Start scanning with camera availability check
        async function startScanning() {
            if (isRunning) return;
            
            const selectedDeviceId = document.getElementById('deviceSelect').value;
            if (!selectedDeviceId) {
                showStatus('Please select a camera first.', 'warning');
                return;
            }
            
            // Handle manual camera option
            if (selectedDeviceId === 'manual_camera') {
                showStatus('Manual mode selected. You can enter barcodes manually below.', 'info');
                document.getElementById('barcodeInput').focus();
                return;
            }
            
            showStatus('Checking camera availability...', 'info');
            
            // Check if camera is in use
            const cameraCheck = await checkCameraInUse(selectedDeviceId);
            if (cameraCheck.inUse) {
                showStatus(cameraCheck.error, 'danger');
                return;
            }
            
            if (cameraCheck.error && !cameraCheck.inUse) {
                showStatus(cameraCheck.error, 'warning');
                // Continue anyway, might still work
            }
            
            showStatus('Starting camera...', 'info');
            
            try {
                // Stop any existing stream
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }
                
                // Get camera stream with optimal constraints
                const constraints = {
                    video: {
                        deviceId: { exact: selectedDeviceId },
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    }
                };
                
                // Add mobile-specific constraints
                if (isMobile) {
                    constraints.video = {
                        ...constraints.video,
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 },
                        frameRate: { ideal: 30, max: 30 }
                    };
                }
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                video.style.display = 'block';
                
                // Initialize ZXing scanner with enhanced settings
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                // Configure scanner with better error handling
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.PURE_BARCODE, true);
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                
                await codeReader.decodeFromVideoDevice(
                    selectedDeviceId,
                    video,
                    (result, error) => {
                        if (result) {
                            const barcode = result.text;
                            console.log('Barcode detected:', barcode);
                            document.getElementById('barcodeInput').value = barcode;
                            document.getElementById('result').textContent = `Detected: ${barcode}`;
                            document.getElementById('result').className = 'alert alert-success';
                            document.getElementById('result').style.display = 'block';
                            document.getElementById('manualUpdateBtn').disabled = false;
                            showStatus('Barcode detected!', 'success');
                            
                            // Automatically update the database with the detected barcode
                            updateProductBarcode(barcode);
                        }
                        // Only log meaningful errors, not continuous scanning attempts
                        if (error && error.name !== 'NotFoundException') {
                            console.log('Scan error (non-critical):', error.name);
                        }
                    }
                );
                
                isRunning = true;
                showStatus('Scanning... Point camera at barcode.', 'success');
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
                
            } catch (err) {
                console.error('Error starting scanner:', err);
                
                // Provide specific error messages
                let errorMessage = 'Error starting camera: ' + err.message;
                if (err.name === 'NotReadableError') {
                    errorMessage = 'Camera is in use by another application. Please close other apps using the camera.';
                } else if (err.name === 'NotAllowedError') {
                    errorMessage = 'Camera access denied. Please allow camera permissions in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage = 'Camera not found. It may have been disconnected or is in use.';
                } else if (err.name === 'OverconstrainedError') {
                    errorMessage = 'Camera does not support the required settings. Please try a different camera.';
                }
                
                showStatus(errorMessage, 'danger');
            }
        }

        // Stop scanning
        function stopScanning() {
            if (!isRunning) return;
            
            try {
                if (codeReader) {
                    codeReader.reset();
                }
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                const video = document.getElementById('video');
                video.style.display = 'none';
                video.srcObject = null;
            } catch (error) {
                console.error('Error stopping scanner:', error);
            }
            
            isRunning = false;
            showStatus('Camera stopped.', 'info');
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
        }

        // Update product barcode
        async function updateProductBarcode(barcode) {
            if (!productId) {
                showStatus('No product ID provided', 'danger');
                return;
            }

            try { 
                const response = await fetch(`${API_URL}/api/productbarcode/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ barcode })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update barcode');
                }

                const result = await response.json();
                showStatus('Barcode updated successfully! Redirecting...', 'success');
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = `edit.html?id=${productId}`;
                }, 2000);
            } catch (error) {
                console.error('Error:', error);
                showStatus('Failed to update barcode: ' + error.message, 'danger');
            }
        }

        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `alert alert-${type}`;
            statusDiv.style.display = 'block';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize cameras
            initializeCameraDevices();
            
            // Set up event listeners
            document.getElementById('startButton').addEventListener('click', startScanning);
            document.getElementById('stopButton').addEventListener('click', stopScanning);  
            document.getElementById('manualUpdateBtn').addEventListener('click', function() {
                const barcode = document.getElementById('barcodeInput').value;
                if (barcode) {
                    updateProductBarcode(barcode);
                }
            });
            
            // Camera selection change handler
            document.getElementById('deviceSelect').addEventListener('change', async function() {
                const selectedDeviceId = this.value;
                if (!selectedDeviceId) {
                    showStatus('Please select a camera.', 'info');
                    return;
                }
                
                // Stop any currently running camera
                if (isRunning) {
                    stopScanning();
                }
                
                // Check if the newly selected camera is available
                showStatus('Checking selected camera...', 'info');
                const cameraCheck = await checkCameraInUse(selectedDeviceId);
                
                if (cameraCheck.inUse) {
                    showStatus(cameraCheck.error, 'danger');
                    // Disable start button if camera is in use
                    document.getElementById('startButton').disabled = true;
                } else if (cameraCheck.error) {
                    showStatus(cameraCheck.error, 'warning');
                    // Still allow starting, might work
                    document.getElementById('startButton').disabled = false;
                } else {
                    showStatus('Camera is available. Click Start Camera to begin scanning.', 'success');
                    document.getElementById('startButton').disabled = false;
                }
            });
        });

        // Comprehensive camera permission and usage checker
        async function checkCameraStatus() {
            console.log('=== CAMERA STATUS CHECK ===');
            
            // Check if mediaDevices is supported
            if (!navigator.mediaDevices) {
                console.error('❌ MediaDevices not supported');
                alert('❌ Your browser does not support camera access');
                return false;
            }
            
            // Check if getUserMedia is supported
            if (!navigator.mediaDevices.getUserMedia) {
                console.error('❌ getUserMedia not supported');
                alert('❌ Camera access not supported in this browser');
                return false;
            }
            
            console.log('✅ MediaDevices and getUserMedia supported');
            
            // Check current permissions
            try {
                const permissions = await navigator.permissions.query({ name: 'camera' });
                console.log('📋 Camera permission state:', permissions.state);
                
                if (permissions.state === 'denied') {
                    console.error('❌ Camera permission denied');
                    alert('❌ Camera permission denied. Please enable camera access in your browser settings.');
                    return false;
                } else if (permissions.state === 'prompt') {
                    console.log('⏳ Camera permission needs to be requested');
                } else if (permissions.state === 'granted') {
                    console.log('✅ Camera permission granted');
                }
            } catch (err) {
                console.log('⚠️ Could not check permissions:', err);
            }
            
            // Try to enumerate devices
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log('📹 Found', videoDevices.length, 'video input devices:');
                videoDevices.forEach((device, index) => {
                    console.log(`  ${index + 1}. ${device.label || 'Unknown Camera'} (ID: ${device.deviceId})`);
                });
                
                if (videoDevices.length === 0) {
                    console.error('❌ No video input devices found');
                    alert('❌ No cameras detected on your device');
                    return false;
                }
            } catch (err) {
                console.error('❌ Could not enumerate devices:', err);
            }
            
            // Test camera access with different methods
            const testMethods = [
                { name: 'Basic video', constraints: { video: true } },
                { name: 'Environment camera', constraints: { video: { facingMode: 'environment' } } },
                { name: 'User camera', constraints: { video: { facingMode: 'user' } } },
                { name: 'Low resolution', constraints: { video: { width: 320, height: 240 } } }
            ];
            
            for (const method of testMethods) {
                try {
                    console.log(`🔍 Testing: ${method.name}`);
                    const stream = await navigator.mediaDevices.getUserMedia(method.constraints);
                    const tracks = stream.getTracks();
                    
                    console.log(`✅ ${method.name} SUCCESS`);
                    console.log('  Tracks found:', tracks.length);
                    tracks.forEach(track => {
                        const settings = track.getSettings();
                        console.log(`  - ${track.kind}: ${settings.width}x${settings.height} @ ${settings.frameRate}fps`);
                    });
                    
                    // Stop the stream immediately
                    tracks.forEach(track => track.stop());
                    console.log(`✅ ${method.name} - Stream stopped successfully`);
                    
                    // If we get here, camera is working
                    alert(`✅ Camera is working! Successfully tested: ${method.name}`);
                    return true;
                    
                } catch (err) {
                    console.error(`❌ ${method.name} FAILED:`, err.name, err.message);
                    
                    if (err.name === 'NotAllowedError') {
                        console.error('  → Permission denied or camera in use');
                    } else if (err.name === 'NotFoundError') {
                        console.error('  → No camera found');
                    } else if (err.name === 'NotReadableError') {
                        console.error('  → Camera is in use by another application');
                    } else if (err.name === 'OverconstrainedError') {
                        console.error('  → Camera constraints not supported');
                    } else if (err.name === 'TypeError') {
                        console.error('  → Invalid constraints');
                    }
                }
            }
            
            console.error('❌ All camera test methods failed');
            alert('❌ Camera access failed. Check console for details.');
            return false;
        }
        
        // Function to check what's using the camera
        async function diagnoseCameraUsage() {
            console.log('=== CAMERA USAGE DIAGNOSIS ===');
            
            // Check for active media streams
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log('📹 Available cameras:', videoDevices.length);
                videoDevices.forEach((device, index) => {
                    console.log(`  ${index + 1}. ${device.label || 'Unknown Camera'} (ID: ${device.deviceId})`);
                });
                
                // Try to get active streams
                if (navigator.mediaDevices.getDisplayMedia) {
                    try {
                        const displayStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                        console.log('🖥️ Screen sharing active:', displayStream.getTracks().length, 'tracks');
                        displayStream.getTracks().forEach(track => track.stop());
                    } catch (err) {
                        console.log('🖥️ No active screen sharing detected');
                    }
                }
                
            } catch (err) {
                console.error('❌ Could not diagnose camera usage:', err);
            }
            
            // Check browser tabs
            console.log('🌐 Check these potential camera users:');
            console.log('  1. Other browser tabs with camera access');
            console.log('  2. Video conferencing apps (Zoom, Teams, etc.)');
            console.log('  3. Social media apps (Facebook, Instagram, etc.)');
            console.log('  4. Security software with camera monitoring');
            console.log('  5. Browser extensions with camera access');
        }
        
        // Enhanced camera usage detection
        async function detectCameraUsage() {
            console.log('=== ENHANCED CAMERA USAGE DETECTION ===');
            
            // Check browser info
            console.log('🌐 Browser Info:');
            console.log('  User Agent:', navigator.userAgent);
            console.log('  Platform:', navigator.platform);
            console.log('  Vendor:', navigator.vendor);
            
            // Check if we're in an iframe (can cause camera issues)
            if (window !== window.top) {
                console.error('❌ Page is in an iframe - this can cause camera issues!');
                alert('❌ This page is loaded in an iframe. Please open it directly in a new tab.');
                return;
            }
            
            // Check for secure context
            if (!window.isSecureContext) {
                console.error('❌ Not in secure context - camera requires HTTPS!');
                alert('❌ Camera access requires HTTPS. Please use https:// or localhost');
                return;
            }
            
            console.log('✅ Secure context confirmed');
            
            // Check for existing streams
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log('📹 Camera devices found:', videoDevices.length);
                videoDevices.forEach((device, index) => {
                    console.log(`  ${index + 1}. ${device.label || 'Unknown Camera'} (ID: ${device.deviceId})`);
                });
                
                // Try to detect if camera is actually in use
                console.log('🔍 Testing camera access with different error handling...');
                
                const testConstraints = [
                    { video: true },
                    { video: { facingMode: 'environment' } },
                    { video: { facingMode: 'user' } },
                    { video: { width: 320, height: 240 } }
                ];
                
                for (let i = 0; i < testConstraints.length; i++) {
                    try {
                        console.log(`  Test ${i + 1}: Trying basic video access...`);
                        const stream = await navigator.mediaDevices.getUserMedia(testConstraints[i]);
                        const tracks = stream.getTracks();
                        
                        console.log(`✅ Test ${i + 1} SUCCESS - Camera is available!`);
                        console.log(`  Tracks: ${tracks.length}`);
                        tracks.forEach(track => {
                            const settings = track.getSettings();
                            console.log(`  - ${track.kind}: ${settings.width}x${settings.height} @ ${settings.frameRate}fps`);
                        });
                        
                        // Stop immediately
                        tracks.forEach(track => track.stop());
                        console.log(`✅ Test ${i + 1} - Stream stopped successfully`);
                        
                        alert(`✅ Camera is working! Successfully tested method ${i + 1}`);
                        return true;
                        
                    } catch (err) {
                        console.error(`❌ Test ${i + 1} FAILED:`, err.name, err.message);
                        
                        if (err.name === 'NotAllowedError') {
                            console.error('  → Permission denied or camera in use');
                            console.error('  → This usually means:');
                            console.error('     - Camera permission denied');
                            console.error('     - Camera is in use by another app');
                            console.error('     - Browser blocked camera access');
                        } else if (err.name === 'NotFoundError') {
                            console.error('  → No camera found');
                        } else if (err.name === 'NotReadableError') {
                            console.error('  → Camera is in use by another application');
                            console.error('  → Common causes:');
                            console.error('     - Another browser tab using camera');
                            console.error('     - Video conferencing app');
                            console.error('     - Windows Camera app');
                            console.error('     - Security software');
                        } else if (err.name === 'OverconstrainedError') {
                            console.error('  → Camera constraints not supported');
                        } else if (err.name === 'TypeError') {
                            console.error('  → Invalid constraints');
                        } else if (err.name === 'AbortError') {
                            console.error('  → Request aborted');
                        } else if (err.name === 'SecurityError') {
                            console.error('  → Security error - check HTTPS');
                        }
                    }
                }
                
                console.error('❌ All camera tests failed');
                console.log('🔧 Troubleshooting steps:');
                console.log('  1. Close ALL other browser tabs');
                console.log('  2. Close video conferencing apps (Zoom, Teams, etc.)');
                console.log('  3. Close Windows Camera app');
                console.log('  4. Check Task Manager for camera processes');
                console.log('  5. Restart browser completely');
                console.log('  6. Try incognito/private mode');
                console.log('  7. Check browser extensions');
                
                alert('❌ Camera is in use by another application. Check console for detailed troubleshooting steps.');
                
            } catch (err) {
                console.error('❌ Could not detect camera usage:', err);
            }
        }

        // Function to force close all camera streams
        async function forceCloseCameraStreams() {
            console.log('=== FORCE CLOSING CAMERA STREAMS ===');
            
            try {
                // Get all media devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log('📹 Found', videoDevices.length, 'video devices');
                
                // Try to get and immediately stop any active streams
                const testConstraints = [
                    { video: true },
                    { video: { facingMode: 'environment' } },
                    { video: { facingMode: 'user' } }
                ];
                
                for (const constraint of testConstraints) {
                    try {
                        console.log('🔍 Attempting to get stream with constraint:', constraint);
                        const stream = await navigator.mediaDevices.getUserMedia(constraint);
                        const tracks = stream.getTracks();
                        
                        console.log('✅ Got stream with', tracks.length, 'tracks - stopping immediately');
                        tracks.forEach(track => {
                            track.stop();
                            console.log('✅ Stopped track:', track.kind);
                        });
                        
                        // Wait a moment for cleanup
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (err) {
                        console.log('⚠️ Could not get stream with constraint:', constraint, err.name);
                    }
                }
                
                console.log('✅ Force close attempt completed');
                alert('✅ Attempted to force close camera streams. Try the camera again now.');
                
            } catch (err) {
                console.error('❌ Error during force close:', err);
                alert('❌ Error during force close. Check console for details.');
            }
        }
        
        // Function to check for browser-specific issues
        function checkBrowserIssues() {
            console.log('=== BROWSER ISSUE CHECK ===');
            
            const userAgent = navigator.userAgent.toLowerCase();
            console.log('🌐 User Agent:', navigator.userAgent);
            
            // Check for common browser issues
            if (userAgent.includes('chrome')) {
                console.log('🔍 Chrome detected - checking for common issues...');
                console.log('  - Chrome sometimes holds camera access between tabs');
                console.log('  - Try closing ALL Chrome tabs and reopening');
                console.log('  - Check chrome://settings/content/camera');
            } else if (userAgent.includes('firefox')) {
                console.log('🔍 Firefox detected - checking for common issues...');
                console.log('  - Firefox may block camera in iframes');
                console.log('  - Check about:preferences#privacy for camera settings');
            } else if (userAgent.includes('safari')) {
                console.log('🔍 Safari detected - checking for common issues...');
                console.log('  - Safari requires explicit permission for camera');
                console.log('  - Check Safari > Preferences > Websites > Camera');
            } else if (userAgent.includes('edge')) {
                console.log('🔍 Edge detected - checking for common issues...');
                console.log('  - Edge may have different permission handling');
                console.log('  - Check edge://settings/content/camera');
            }
            
            // Check for mobile
            if (/android|iphone|ipad|ipod|blackberry|windows phone/i.test(userAgent)) {
                console.log('📱 Mobile device detected - additional considerations:');
                console.log('  - Mobile browsers have stricter camera access');
                console.log('  - May require user interaction to start camera');
                console.log('  - Some mobile browsers block camera in iframes');
            }
            
            // Check for iframe
            if (window !== window.top) {
                console.error('❌ Page is in an iframe - this often causes camera issues!');
                alert('❌ This page is loaded in an iframe. Please open it directly in a new tab.');
                return false;
            }
            
            // Check for secure context
            if (!window.isSecureContext) {
                console.error('❌ Not in secure context - camera requires HTTPS!');
                alert('❌ Camera access requires HTTPS. Please use https:// or localhost');
                return false;
            }
            
            console.log('✅ Basic browser checks passed');
            return true;
        }
    </script>
</body>
</html> 